<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature: User Authentication and Context Management - Carmen ERP Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .sidebar nav {
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-section ul {
            list-style: none;
        }

        .nav-section a {
            display: block;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-section a:hover,
        .nav-section a.active {
            background: var(--bg-light);
            color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 280px);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-wrapper {
            display: flex;
            gap: 2rem;
        }

        .document-content {
            flex: 1;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            min-width: 0;
        }

        .toc-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .toc-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list a {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--primary);
        }

        .toc-list .toc-h2 {
            margin-left: 0;
            font-weight: 500;
        }

        .toc-list .toc-h3 {
            margin-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            margin-left: 2rem;
            font-size: 0.75rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        img {
            max-width: 600px;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin: 1rem 0;
            display: block;
        }

        .mermaid {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border);
            max-width: 800px;
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            max-height: 500px;
            height: auto;
            transform: scale(0.85);
            transform-origin: top center;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .toc-sidebar {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // Initialize Mermaid with enhanced configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                background: '#ffffff',
                mainBkg: '#f8fafc',
                secondBkg: '#e2e8f0',
                border1: '#cbd5e1',
                border2: '#94a3b8'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            }
        });

        // Expose mermaid globally and signal it's ready
        window.mermaid = mermaid;
        window.mermaidReady = true;

        // Dispatch event when mermaid is ready
        window.dispatchEvent(new Event('mermaidLoaded'));
    </script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="back-link">‚Üê All Modules</a>
            <h1>SR</h1>
        </div>

        <nav>
            <div class="nav-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="../index.html">Module Overview</a></li>
                    <li><a href="../index.html#features">Features</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <div class="breadcrumb"><a href="../index.html">Documentation</a> / <a href="../index.html">SR</a></div>

        <div class="content-wrapper">
            <div class="document-content" id="markdown-content"></div>

            <aside class="toc-sidebar">
                <div class="toc-sticky">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const markdownContent = "# Feature: User Authentication and Context Management\n\n## Description\nThe Carmen ERP User Authentication and Context Management System provides a sophisticated multi-role, multi-department, and multi-location user management framework. The system features dynamic user context switching allowing users to operate with different roles across various departments and locations within a single session. It implements role-based access control with granular permissions, price visibility controls based on user roles, and comprehensive user profile management with department and location assignments.\n\n## Process Flow (Step by Step)\n\n### User Authentication\n1. User accesses the system and is authenticated through SimpleUserProvider context\n2. System loads user profile with available roles, departments, and locations\n3. Default user context is established based on user's primary role and assignment\n4. Authentication state is maintained throughout the session with automatic refresh\n5. System provides role-based navigation filtering and feature access control\n\n### Context Switching\n6. User can switch active role via UserContextSwitcher component\n7. System validates role availability and updates user context immediately\n8. Navigation and feature availability updates based on new role permissions\n9. Price visibility toggles automatically based on role-specific settings\n10. Department switching updates operational context and data filtering\n11. Location switching affects inventory visibility and operational scope\n12. All context changes are logged for audit and tracking purposes\n\n### Role-Based Access Control\n13. System implements granular permission system through role definitions\n14. Each role has specific capabilities: staff, department-manager, financial-manager, purchasing-staff, counter, chef\n15. Permission validation occurs at component and API levels\n16. Price visibility controlled by user.context.showPrices flag based on role\n17. Workflow approval rights determined by role and department combination\n18. Feature access dynamically filtered based on role permissions\n\n### User Profile Management\n19. Comprehensive user profiles include personal information, role assignments, and preferences\n20. Multi-department assignments allow users to operate across organizational units\n21. Location assignments define physical or logical operational scope\n22. User preferences include language settings, notification preferences, and UI customizations\n23. Profile updates require appropriate approval workflows based on change sensitivity\n\n## Flow Diagram (Mermaid)\n```mermaid\nflowchart TD\n    A[User Login] --> B[Authentication Check]\n    B --> C[Load User Profile]\n    C --> D[Initialize User Context]\n    D --> E[Set Default Role/Department/Location]\n    E --> F[Apply Permission Filters]\n    F --> G[Render User Interface]\n\n    G --> H{Context Change Requested?}\n    H -->|Role Switch| I[Validate Role Availability]\n    H -->|Department Switch| J[Validate Department Access]\n    H -->|Location Switch| K[Validate Location Access]\n    H -->|No Change| L[Continue Session]\n\n    I --> M[Update Role Context]\n    J --> N[Update Department Context]\n    K --> O[Update Location Context]\n\n    M --> P[Refresh Permissions]\n    N --> P\n    O --> P\n    P --> Q[Update Navigation]\n    Q --> R[Update Feature Access]\n    R --> S[Update Price Visibility]\n    S --> T[Log Context Change]\n    T --> G\n\n    L --> U{Session Expired?}\n    U -->|Yes| V[Re-authenticate]\n    U -->|No| G\n    V --> B\n\n    G --> W[API Request]\n    W --> X[Validate Permissions]\n    X --> Y{Authorized?}\n    Y -->|Yes| Z[Process Request]\n    Y -->|No| AA[Return Unauthorized]\n    Z --> G\n    AA --> BB[Show Error Message]\n    BB --> G\n```\n\n## Screen Capture Locations\n- Capture: Login screen with authentication form\n- Capture: User context switcher showing available roles, departments, and locations\n- Capture: Navigation menu showing role-based filtering of available options\n- Capture: Price visibility differences between staff and manager views\n- Capture: User profile management with role assignments and preferences\n- Capture: Permission-based feature access (showing enabled/disabled states)\n- Capture: Audit log showing context changes and user activities\n- Capture: Multi-department user accessing different department contexts\n\n## Schema Entities (Plain Text)\nUser: Core user entity with id, name, email, role, department, location, availableRoles, availableDepartments, availableLocations, preferences, and context settings.\nUserContext: Active session context with currentRole, currentDepartment, currentLocation, showPrices flag, and operational preferences.\nRole: Role definition with name, description, permissions array, and system capabilities.\nDepartment: Organizational unit with id, name, description, parent department, and operational scope.\nLocation: Physical or logical location with id, name, type, address, and operational parameters.\nPermission: Granular permission with resource, action, scope, and conditions.\nUserSession: Session management with sessionId, userId, loginTime, lastActivity, and contextHistory.\n\n## Major Authentication and Context Features\n\n### Authentication System\n- **Simple User Provider**: Mock authentication system for prototype development\n- **Session Management**: Persistent session state with automatic refresh\n- **Role Validation**: Dynamic role availability checking and assignment\n- **Security Context**: Comprehensive security context maintained throughout session\n- **Audit Trail**: Complete logging of authentication events and context changes\n\n### Dynamic Context Switching\n- **Real-Time Role Switching**: Immediate role changes with permission updates\n- **Department Context**: Switch operational context between departments\n- **Location Context**: Change location scope for inventory and operations\n- **Context History**: Track context changes for audit and user experience\n- **Validation Rules**: Ensure users only access authorized contexts\n\n### Role-Based Access Control\n- **Granular Permissions**: Fine-grained permission system for features and data\n- **Hierarchical Roles**: Role hierarchy with inheritance of permissions\n- **Department-Specific Permissions**: Role permissions scoped to departments\n- **Dynamic Feature Access**: Real-time feature availability based on role\n- **API-Level Security**: Permission validation at all system integration points\n\n### Price Visibility Management\n- **Role-Based Price Display**: Price visibility controlled by user role\n- **Dynamic Price Hiding**: Real-time price display control throughout system\n- **Permission Override**: Administrative override for price visibility\n- **Context-Sensitive Display**: Price visibility changes with role switching\n- **Audit Compliance**: Tracking of price access for compliance purposes\n\n### User Profile Management\n- **Multi-Role Assignment**: Users can hold multiple roles simultaneously\n- **Department Assignments**: Users assigned to multiple departments\n- **Location Access**: Location-based access control and assignment\n- **Preference Management**: User-specific system preferences and customizations\n- **Profile Validation**: Validation rules for user assignments and combinations\n\n### Integration and Workflow\n- **Workflow Integration**: Role-based approval and workflow routing\n- **Navigation Filtering**: Dynamic menu and feature filtering\n- **Data Access Control**: Role-based data filtering and access control\n- **Cross-Module Integration**: Consistent permission model across all modules\n- **Scalable Architecture**: Support for complex organizational structures\n\n## Ambiguities & Assumptions\nAssumption: Users can hold multiple roles but only one role is active at any given time during a session.\nAssumption: Price visibility is primarily controlled by role but can be overridden by specific permissions.\nAmbiguity: The specific permission matrix for each role and the inheritance rules between roles are not explicitly defined.\nAssumption: Context switching is immediate and does not require re-authentication within the same session.\nAmbiguity: The exact business rules for department and location access validation need detailed specification.\nAssumption: All user context changes are logged for audit purposes and compliance tracking.\nAssumption: The system supports complex organizational hierarchies with multiple levels of departments and locations.\nAmbiguity: Integration with external authentication systems (LDAP, Active Directory) and single sign-on capabilities are not clearly specified.";

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = marked.parse(markdownContent);

        // Function to render Mermaid diagrams
        function renderMermaidDiagrams() {
            if (!window.mermaid) {
                console.log('Mermaid not loaded yet, waiting...');
                return;
            }

            // Find all code blocks with mermaid language
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');

            if (mermaidBlocks.length === 0) {
                console.log('No mermaid blocks found');
                return;
            }

            console.log('Found', mermaidBlocks.length, 'mermaid blocks');

            mermaidBlocks.forEach((block, index) => {
                const mermaidCode = block.textContent;
                const pre = block.parentElement;

                // Create a div for mermaid diagram
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.id = 'mermaid-diagram-' + index;

                // Replace the pre block with mermaid div
                pre.replaceWith(mermaidDiv);
            });

            // Run mermaid rendering
            window.mermaid.run({
                querySelector: '.mermaid'
            }).then(() => {
                console.log('Mermaid diagrams rendered successfully');
            }).catch(err => {
                console.error('Mermaid rendering error:', err);
            });
        }

        // Wait for mermaid to load before rendering
        if (window.mermaidReady) {
            renderMermaidDiagrams();
        } else {
            window.addEventListener('mermaidLoaded', renderMermaidDiagrams);
            // Fallback timeout
            setTimeout(renderMermaidDiagrams, 1000);
        }

        // Generate TOC from headings
        const tocList = document.getElementById('toc-list');
        const headings = contentDiv.querySelectorAll('h2, h3, h4');

        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    tocList.querySelectorAll('a').forEach(a => {
                        a.style.color = a.getAttribute('href') === '#' + id ? 'var(--primary)' : 'var(--text-secondary)';
                        a.style.fontWeight = a.getAttribute('href') === '#' + id ? '600' : '400';
                    });
                }
            });
        }, { threshold: 1.0 });

        headings.forEach(heading => observer.observe(heading));
    </script>
</body>
</html>