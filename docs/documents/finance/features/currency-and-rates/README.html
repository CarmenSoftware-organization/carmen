<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Management & Exchange Rates - Carmen ERP Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .sidebar nav {
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-section ul {
            list-style: none;
        }

        .nav-section a {
            display: block;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-section a:hover,
        .nav-section a.active {
            background: var(--bg-light);
            color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 280px);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-wrapper {
            display: flex;
            gap: 2rem;
        }

        .document-content {
            flex: 1;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            min-width: 0;
        }

        .toc-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .toc-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list a {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--primary);
        }

        .toc-list .toc-h2 {
            margin-left: 0;
            font-weight: 500;
        }

        .toc-list .toc-h3 {
            margin-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            margin-left: 2rem;
            font-size: 0.75rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        img {
            max-width: 600px;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin: 1rem 0;
            display: block;
        }

        .mermaid {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border);
            max-width: 800px;
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            max-height: 500px;
            height: auto;
            transform: scale(0.85);
            transform-origin: top center;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .toc-sidebar {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // Initialize Mermaid with enhanced configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                background: '#ffffff',
                mainBkg: '#f8fafc',
                secondBkg: '#e2e8f0',
                border1: '#cbd5e1',
                border2: '#94a3b8'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            }
        });

        // Expose mermaid globally and signal it's ready
        window.mermaid = mermaid;
        window.mermaidReady = true;

        // Dispatch event when mermaid is ready
        window.dispatchEvent(new Event('mermaidLoaded'));
    </script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../../../index.html" class="back-link">← All Modules</a>
            <h1>Finance</h1>
        </div>

        <nav>
            <div class="nav-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="../../../index.html">Module Overview</a></li>
                    <li><a href="../../../index.html#features">Features</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <div class="breadcrumb"><a href="../../../index.html">Documentation</a> / <a href="../../../index.html">FINANCE</a> / Features / Currency And Rates</div>

        <div class="content-wrapper">
            <div class="document-content" id="markdown-content"></div>

            <aside class="toc-sidebar">
                <div class="toc-sticky">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const markdownContent = "# Currency Management & Exchange Rates\n\n> **Features:** Finance > Currency Management & Exchange Rates\n> **Pages:** 4 (2 Currency + 2 Exchange Rates)\n> **Status:** ✅ Production Ready\n\n---\n\n## Overview\n\nCurrency Management and Exchange Rates provide comprehensive multi-currency support for Carmen ERP, enabling international operations with automatic currency conversion, real-time exchange rate tracking, and accurate financial reporting across multiple currencies.\n\n---\n\n# Currency Management\n\n## Overview\n\nConfigure and manage all currencies used in the system, including activation controls, currency descriptions, and integration with transactions across all modules.\n\n### Page Structure\n\n**Route:** `/finance/currency-management`\n\n---\n\n## Data Model\n\n```typescript\ninterface Currency {\n  // Identity\n  code: string; // ISO 4217 (3-letter code: USD, EUR, GBP)\n  description: string; // Full currency name\n  symbol?: string; // Currency symbol ($, €, £)\n\n  // Configuration\n  active: boolean; // Enable/disable for transactions\n  decimalPlaces?: number; // Decimal precision (default: 2)\n\n  // Metadata\n  createdAt: string;\n  updatedAt: string;\n  createdBy: string;\n  lastModifiedBy: string;\n}\n\n// Example Currencies\nconst currencies: Currency[] = [\n  {\n    code: 'USD',\n    description: 'United States Dollar',\n    symbol: '$',\n    active: true,\n    decimalPlaces: 2\n  },\n  {\n    code: 'EUR',\n    description: 'Euro',\n    symbol: '€',\n    active: true,\n    decimalPlaces: 2\n  },\n  {\n    code: 'JPY',\n    description: 'Japanese Yen',\n    symbol: '¥',\n    active: true,\n    decimalPlaces: 0\n  },\n  {\n    code: 'GBP',\n    description: 'British Pound Sterling',\n    symbol: '£',\n    active: true,\n    decimalPlaces: 2\n  }\n];\n```\n\n---\n\n## Features & Functionality\n\n### 1. Currency List View\n\n**Columns:**\n- Selection checkbox (for bulk operations)\n- **Currency Code**: ISO 4217 code\n- **Currency Description**: Full name\n- **Active**: Status toggle checkbox\n- **Actions**: Edit/Delete options\n\n**Features:**\n- Sortable columns\n- Multi-select for bulk operations\n- Inline activation toggle\n- Real-time search filtering\n- Active-only filter\n\n### 2. Search & Filter\n\n**Search:**\n- Search by currency code\n- Search by description\n- Real-time filtering\n- Case-insensitive\n\n**Filter:**\n- \"Show Active\" checkbox\n- Filter active/inactive currencies\n- Combined with search\n\n### 3. Currency Operations\n\n**Create Currency:**\n1. Click \"Create\" button\n2. Enter currency code (ISO 4217)\n3. Enter description\n4. Set active status\n5. Save\n\n**Activate/Deactivate:**\n- Toggle checkbox in Active column\n- Immediate update\n- Confirmation for deactivation if currency in use\n\n**Delete Currency:**\n1. Select currencies via checkbox\n2. Click \"Delete\" button\n3. Confirmation dialog\n4. Delete if no transactions exist\n\n### 4. Bulk Operations\n\n**Actions:**\n- Bulk activate\n- Bulk deactivate\n- Bulk delete\n- Bulk export\n\n**Print:**\n- Print currency list\n- PDF export\n- Filtered results\n\n---\n\n## Business Rules\n\n### Currency Validation\n\n1. **ISO 4217 Compliance**: Currency code must be valid ISO 4217 code\n2. **Unique Codes**: No duplicate currency codes allowed\n3. **Active Check**: At least one currency must be active (typically base currency)\n4. **Delete Protection**: Cannot delete currency with existing transactions\n5. **Deactivation Warning**: Warn if deactivating currency with pending transactions\n\n### Currency Configuration\n\n1. **Base Currency**: System designates one base currency (often USD)\n2. **Decimal Places**: Configurable per currency (JPY = 0, most others = 2)\n3. **Symbol Display**: Optional currency symbol for UI display\n4. **Description Required**: Full currency name mandatory\n\n### System Integration\n\n1. **Default Currency**: New transactions default to base currency\n2. **Multi-Currency Transactions**: Can create transactions in any active currency\n3. **Reporting**: All reports can display in base currency or transaction currency\n4. **Exchange Rate Linkage**: Active currencies require exchange rates\n\n---\n\n# Exchange Rate Management\n\n## Overview\n\nManage exchange rates for currency conversion, supporting both manual entry and automated updates from external sources.\n\n### Page Structure\n\n**Route:** `/finance/exchange-rates`\n\n---\n\n## Data Model\n\n```typescript\ninterface ExchangeRate {\n  // Identity\n  code: string; // Currency code (foreign currency)\n  name: string; // Currency full name\n\n  // Rate Information\n  rate: number; // Exchange rate (6 decimal precision)\n  baseCurrency: string; // Base currency (e.g., 'USD')\n  rateType: 'manual' | 'automatic' | 'api';\n\n  // Temporal\n  effectiveDate: string; // When rate becomes active\n  expiryDate?: string; // When rate expires (optional)\n  lastUpdated: string; // Last update timestamp\n\n  // Source\n  source?: string; // Rate provider (e.g., 'Central Bank', 'XE.com')\n  updatedBy?: string; // User who updated (for manual)\n\n  // Metadata\n  historical: boolean; // Is this a historical rate?\n}\n\n// Example Exchange Rates\nconst exchangeRates: ExchangeRate[] = [\n  {\n    code: \"USD\",\n    name: \"United States Dollar\",\n    rate: 1.000000,\n    baseCurrency: \"USD\",\n    rateType: \"manual\",\n    effectiveDate: \"2023-07-01\",\n    lastUpdated: \"2023-07-01\",\n    historical: false\n  },\n  {\n    code: \"EUR\",\n    name: \"Euro\",\n    rate: 0.920000,\n    baseCurrency: \"USD\",\n    rateType: \"api\",\n    effectiveDate: \"2023-07-01\",\n    lastUpdated: \"2023-07-01\",\n    source: \"ECB\",\n    historical: false\n  },\n  {\n    code: \"JPY\",\n    name: \"Japanese Yen\",\n    rate: 144.500000,\n    baseCurrency: \"USD\",\n    rateType: \"api\",\n    effectiveDate: \"2023-07-01\",\n    lastUpdated: \"2023-07-01\",\n    source: \"BOJ\",\n    historical: false\n  }\n];\n```\n\n---\n\n## Features & Functionality\n\n### 1. Exchange Rate Viewer\n\n**Columns:**\n- **Currency Code**: ISO code\n- **Currency Name**: Full name\n- **Rate**: Exchange rate (6 decimals)\n- **Last Updated**: Timestamp\n- **Actions**: Edit/Delete/History\n\n**Display Features:**\n- Current rates only (default)\n- Historical rates view (optional)\n- Color-coded rate changes (increase/decrease)\n- Sortable by any column\n\n### 2. Rate Entry Methods\n\n**Method 1: Manual Entry**\n1. Click \"Add Rate\" button\n2. Select currency\n3. Enter rate (6 decimal places)\n4. Set effective date\n5. Optional: Add source/notes\n6. Save\n\n**Method 2: CSV Import**\n1. Click \"Import CSV\" button\n2. Download template (optional)\n3. Prepare CSV file:\n   ```csv\n   Currency Code,Rate,Effective Date,Source\n   EUR,0.920000,2023-07-01,ECB\n   JPY,144.500000,2023-07-01,BOJ\n   GBP,0.790000,2023-07-01,BoE\n   ```\n4. Upload file\n5. Validate and preview\n6. Confirm import\n\n**Method 3: API Integration (Future)**\n- Configure API provider\n- Schedule automatic updates\n- Real-time rate fetching\n\n### 3. Search & Filter\n\n**Search:**\n- Currency code\n- Currency name\n- Quick lookup\n\n**Filter:**\n- Date range\n- Rate type (manual/automatic/api)\n- Currency group (e.g., European, Asian)\n- Active currencies only\n\n### 4. Rate History\n\n**Historical Tracking:**\n- View all historical rates for a currency\n- Compare rates over time\n- Rate change percentage\n- Trend visualization\n\n**History Table:**\n- Effective date\n- Rate value\n- Rate change (%)\n- Source\n- Updated by\n- Timestamp\n\n---\n\n## Currency Conversion\n\n### Conversion Logic\n\n```typescript\nfunction convertCurrency(\n  amount: number,\n  fromCurrency: string,\n  toCurrency: string,\n  exchangeRates: ExchangeRate[]\n): number {\n  // Both currencies are the same\n  if (fromCurrency === toCurrency) {\n    return amount;\n  }\n\n  // Get exchange rates\n  const fromRate = exchangeRates.find(r => r.code === fromCurrency)?.rate || 1;\n  const toRate = exchangeRates.find(r => r.code === toCurrency)?.rate || 1;\n\n  // Convert to base currency first, then to target currency\n  const baseAmount = amount / fromRate;\n  const convertedAmount = baseAmount * toRate;\n\n  return convertedAmount;\n}\n\n// Example usage\nconst usdAmount = 100;\nconst eurRate = 0.92; // 1 USD = 0.92 EUR\nconst eurAmount = convertCurrency(usdAmount, 'USD', 'EUR', exchangeRates);\n// Result: 92.00 EUR\n```\n\n### Conversion Rules\n\n1. **Base Currency**: All conversions go through base currency\n2. **Rate Precision**: Maintain 6 decimal precision during calculation\n3. **Rounding**: Round final result to currency decimal places\n4. **Rate Date**: Use rate effective on transaction date\n5. **Missing Rate**: Error if no rate available for transaction date\n\n---\n\n## Business Rules\n\n### Exchange Rate Management\n\n1. **Base Currency Rate**: Base currency always has rate of 1.000000\n2. **Rate Precision**: All rates stored with 6 decimal places\n3. **Effective Date Required**: Every rate must have effective date\n4. **Rate History**: System maintains complete rate history\n5. **No Retroactive Changes**: Cannot modify historical rates (create new rate instead)\n\n### Rate Updates\n\n1. **Manual Override**: Manual rates take precedence over automatic\n2. **Update Frequency**:\n   - Manual: On-demand\n   - API: Configurable (hourly, daily, weekly)\n3. **Rate Validation**: Warn if rate change exceeds threshold (e.g., >10%)\n4. **Source Tracking**: Record source of all rate updates\n\n### Transaction Impact\n\n1. **Transaction Currency**: Transactions store original currency amount\n2. **Base Currency Equivalent**: Also store base currency amount at transaction time\n3. **Rate Locking**: Transaction uses rate from transaction date\n4. **Recalculation**: Can recalculate base amounts if rate corrected\n\n---\n\n## Integration Points\n\n### Multi-Currency Transactions\n\n**Purchase Orders:**\n```\nPO in EUR → Exchange Rate (EUR to USD) → USD Equivalent\n```\n\n**Vendor Invoices:**\n```\nInvoice in GBP → Exchange Rate (GBP to USD) → USD Posting\n```\n\n**Sales:**\n```\nSale in JPY → Exchange Rate (JPY to USD) → USD Revenue\n```\n\n### Financial Reporting\n\n**Currency Presentation:**\n- Transactional Currency (original)\n- Base Currency (converted)\n- Reporting Currency (optional third currency)\n\n**Exchange Gain/Loss:**\n- Track realized gains/losses on settlement\n- Track unrealized gains/losses on open items\n- Automatic GL posting for gains/losses\n\n---\n\n## API Endpoints\n\n```http\n# Currency Management\nGET /api/finance/currencies\nPOST /api/finance/currencies\nPUT /api/finance/currencies/:code\nDELETE /api/finance/currencies/:code\nPATCH /api/finance/currencies/:code/activate\nPATCH /api/finance/currencies/:code/deactivate\n\n# Exchange Rates\nGET /api/finance/exchange-rates\nPOST /api/finance/exchange-rates\nPUT /api/finance/exchange-rates/:id\nDELETE /api/finance/exchange-rates/:id\n\n# Rate Lookup\nGET /api/finance/exchange-rates/current\nGET /api/finance/exchange-rates/history/:code\nGET /api/finance/exchange-rates/on-date?date=YYYY-MM-DD\nPOST /api/finance/exchange-rates/convert\n\n# Bulk Operations\nPOST /api/finance/exchange-rates/import\nGET /api/finance/exchange-rates/export\nPOST /api/finance/exchange-rates/update-all\n```\n\n---\n\n## User Guide\n\n### Adding a Currency\n\n1. Navigate to Currency Management\n2. Click \"Create\" button\n3. Enter currency code (e.g., CAD)\n4. Enter description (e.g., Canadian Dollar)\n5. Check \"Active\" checkbox\n6. Save\n\n### Updating Exchange Rates\n\n**Single Rate:**\n1. Navigate to Exchange Rates\n2. Find currency row\n3. Click edit icon\n4. Enter new rate\n5. Save\n\n**Bulk Update via CSV:**\n1. Click \"Import CSV\"\n2. Download template\n3. Fill in rates\n4. Upload file\n5. Review preview\n6. Confirm\n\n### Viewing Rate History\n\n1. Navigate to Exchange Rates\n2. Click on currency row\n3. Select \"View History\"\n4. Browse historical rates\n5. Export history if needed\n\n---\n\n## Troubleshooting\n\n### Issue: Currency Won't Delete\n**Cause**: Currency has associated transactions\n**Solution**: Deactivate currency instead of deleting\n\n### Issue: Exchange Rate Not Found\n**Cause**: No rate configured for transaction date\n**Solution**: Add historical rate for that date or use current rate\n\n### Issue: CSV Import Fails\n**Cause**: Invalid format or missing required fields\n**Solution**: Download template, verify data format, check currency codes\n\n### Issue: Rate Conversion Incorrect\n**Cause**: Using wrong base currency or outdated rate\n**Solution**: Verify base currency setting, check rate effective dates\n\n---\n\n## Best Practices\n\n### Currency Setup\n\n1. **Complete Setup First**: Configure all currencies before transactions\n2. **ISO Compliance**: Always use ISO 4217 codes\n3. **Descriptive Names**: Use full currency names\n4. **Active Management**: Keep inactive list clean\n\n### Exchange Rate Management\n\n1. **Daily Updates**: Update rates daily for accuracy\n2. **Rate Validation**: Cross-check rates with official sources\n3. **Historical Preservation**: Never delete historical rates\n4. **Audit Trail**: Review rate changes regularly\n5. **Backup**: Export rates weekly for backup\n\n### Multi-Currency Operations\n\n1. **Consistent Base**: Use one base currency across organization\n2. **Rate Documentation**: Document rate sources and methodology\n3. **Threshold Alerts**: Set alerts for significant rate changes\n4. **Reconciliation**: Regular forex reconciliation\n5. **Reporting**: Use consistent currency for executive reports\n\n---\n\n## Future Enhancements\n\n**Planned Features:**\n- Real-time API integration with forex providers\n- Automatic rate alerts for significant changes\n- Currency basket support\n- Forward contract management\n- Hedging recommendations\n- Multi-base currency support\n- Custom conversion rules\n- Advanced analytics and trending\n\n---\n\n**Last Updated:** 2025-01-17\n**Version:** 1.0.0\n";

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = marked.parse(markdownContent);

        // Function to render Mermaid diagrams
        function renderMermaidDiagrams() {
            if (!window.mermaid) {
                console.log('Mermaid not loaded yet, waiting...');
                return;
            }

            // Find all code blocks with mermaid language
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');

            if (mermaidBlocks.length === 0) {
                console.log('No mermaid blocks found');
                return;
            }

            console.log('Found', mermaidBlocks.length, 'mermaid blocks');

            mermaidBlocks.forEach((block, index) => {
                const mermaidCode = block.textContent;
                const pre = block.parentElement;

                // Create a div for mermaid diagram
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.id = 'mermaid-diagram-' + index;

                // Replace the pre block with mermaid div
                pre.replaceWith(mermaidDiv);
            });

            // Run mermaid rendering
            window.mermaid.run({
                querySelector: '.mermaid'
            }).then(() => {
                console.log('Mermaid diagrams rendered successfully');
            }).catch(err => {
                console.error('Mermaid rendering error:', err);
            });
        }

        // Wait for mermaid to load before rendering
        if (window.mermaidReady) {
            renderMermaidDiagrams();
        } else {
            window.addEventListener('mermaidLoaded', renderMermaidDiagrams);
            // Fallback timeout
            setTimeout(renderMermaidDiagrams, 1000);
        }

        // Generate TOC from headings
        const tocList = document.getElementById('toc-list');
        const headings = contentDiv.querySelectorAll('h2, h3, h4');

        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    tocList.querySelectorAll('a').forEach(a => {
                        a.style.color = a.getAttribute('href') === '#' + id ? 'var(--primary)' : 'var(--text-secondary)';
                        a.style.fontWeight = a.getAttribute('href') === '#' + id ? '600' : '400';
                    });
                }
            });
        }, { threshold: 1.0 });

        headings.forEach(heading => observer.observe(heading));
    </script>
</body>
</html>