<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Management - Carmen ERP Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .sidebar nav {
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-section ul {
            list-style: none;
        }

        .nav-section a {
            display: block;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-section a:hover,
        .nav-section a.active {
            background: var(--bg-light);
            color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 280px);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-wrapper {
            display: flex;
            gap: 2rem;
        }

        .document-content {
            flex: 1;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            min-width: 0;
        }

        .toc-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .toc-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list a {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--primary);
        }

        .toc-list .toc-h2 {
            margin-left: 0;
            font-weight: 500;
        }

        .toc-list .toc-h3 {
            margin-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            margin-left: 2rem;
            font-size: 0.75rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        img {
            max-width: 600px;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin: 1rem 0;
            display: block;
        }

        .mermaid {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border);
            max-width: 800px;
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            max-height: 500px;
            height: auto;
            transform: scale(0.85);
            transform-origin: top center;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .toc-sidebar {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // Initialize Mermaid with enhanced configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                background: '#ffffff',
                mainBkg: '#f8fafc',
                secondBkg: '#e2e8f0',
                border1: '#cbd5e1',
                border2: '#94a3b8'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            }
        });

        // Expose mermaid globally and signal it's ready
        window.mermaid = mermaid;
        window.mermaidReady = true;

        // Dispatch event when mermaid is ready
        window.dispatchEvent(new Event('mermaidLoaded'));
    </script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../../../index.html" class="back-link">← All Modules</a>
            <h1>Finance</h1>
        </div>

        <nav>
            <div class="nav-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="../../../index.html">Module Overview</a></li>
                    <li><a href="../../../index.html#features">Features</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <div class="breadcrumb"><a href="../../../index.html">Documentation</a> / <a href="../../../index.html">FINANCE</a> / Features / Departments</div>

        <div class="content-wrapper">
            <div class="document-content" id="markdown-content"></div>

            <aside class="toc-sidebar">
                <div class="toc-sticky">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const markdownContent = "# Department Management\n\n> **Feature:** Finance > Department Management\n> **Pages:** 1\n> **Status:** ✅ Production Ready\n\n---\n\n## Overview\n\nDepartment Management provides organizational structure configuration for Carmen ERP, enabling cost center tracking, departmental hierarchy, budget allocation, and expense categorization. This feature integrates with Account Code Mapping to ensure proper GL account assignment by department.\n\n### Key Capabilities\n\n1. **Department CRUD** - Create, edit, and manage departments\n2. **Head of Department** - Assign multiple department heads\n3. **Account Code Linking** - Link departments to default GL accounts\n4. **Active Status Management** - Enable/disable departments\n5. **Search & Filter** - Quick department lookup\n\n---\n\n## Page Structure\n\n**Route:** `/finance/department-list`\n\n---\n\n## Data Model\n\n```typescript\ninterface Department {\n  // Identity\n  code: string; // Department code (2-4 characters)\n  name: string; // Department name/description\n\n  // Leadership\n  heads: string[]; // Array of email addresses for department heads\n\n  // Financial\n  accountCode: string; // Default GL account code for department expenses\n  costCenter?: string; // Cost center code\n  budget?: Money; // Annual or period budget\n\n  // Configuration\n  active: boolean; // Is department active?\n\n  // Hierarchy\n  parentDepartment?: string; // Parent department code\n  level?: number; // Hierarchy level (1 = top level)\n\n  // Metadata\n  createdAt: string;\n  updatedAt: string;\n  createdBy: string;\n  lastModifiedBy: string;\n}\n\n// Example Departments\nconst departments: Department[] = [\n  {\n    code: \"AC\",\n    name: \"Finance / Accounting\",\n    heads: [\"finance.head@example.com\"],\n    accountCode: \"1\",\n    active: true\n  },\n  {\n    code: \"AD\",\n    name: \"Administrator\",\n    heads: [\"admin1@example.com\", \"admin2@example.com\"],\n    accountCode: \"\",\n    active: true\n  },\n  {\n    code: \"FB\",\n    name: \"Food and Beverage\",\n    heads: [\"fb.manager@example.com\"],\n    accountCode: \"\",\n    active: false\n  },\n  {\n    code: \"HR\",\n    name: \"Human Resources\",\n    heads: [\"hr.director@example.com\"],\n    accountCode: \"\",\n    active: true\n  }\n];\n```\n\n---\n\n## Features & Functionality\n\n### 1. Department List View\n\n**Columns:**\n- **Code**: Department code (badge display)\n- **Name**: Full department name\n- **Head of Department**: Email(s) of department head(s)\n- **Account Code**: Linked GL account\n- **Active**: Status checkbox (display only)\n- **Actions**: Edit/Delete buttons\n\n**Features:**\n- Sortable columns\n- Search by code or name\n- Real-time filtering\n- Responsive table design\n- Badge styling for codes\n\n### 2. Department Creation/Edit Modal\n\n**Form Fields:**\n\n**Basic Information:**\n- **Code** (required): 2-4 character unique code\n- **Name** (required): Full department name\n- **Account Code** (optional): Default GL account\n- **Active**: Checkbox for status\n\n**Department Heads:**\n- List of assigned heads (email addresses)\n- Add new head (email input + Add button)\n- Remove existing head (Remove button per entry)\n- Multiple heads supported\n\n**Modal Actions:**\n- Save: Create or update department\n- Cancel: Close without saving\n- X button: Close modal\n\n### 3. Search Functionality\n\n**Search Features:**\n- Search icon indicator\n- Real-time filtering\n- Search across:\n  - Department code\n  - Department name\n- Case-insensitive matching\n- Clear search capability\n\n### 4. Department Operations\n\n**Create Department:**\n1. Click \"New Department\" button\n2. Fill in department code\n3. Enter department name\n4. Add account code (optional)\n5. Set active status\n6. Add department head(s)\n7. Save\n\n**Edit Department:**\n1. Click Edit icon in Actions column\n2. Modify fields as needed\n3. Add/remove department heads\n4. Save changes\n\n**Delete Department:**\n1. Click Delete icon in Actions column\n2. Confirm deletion\n3. Department removed (if no dependencies)\n\n---\n\n## Business Rules\n\n### Department Validation\n\n1. **Unique Code**: Department codes must be unique across organization\n2. **Code Format**: 2-4 uppercase alphanumeric characters\n3. **Name Required**: Department name is mandatory\n4. **Head Email Validation**: Email addresses must be valid format\n5. **Delete Protection**: Cannot delete department with:\n   - Active transactions\n   - Assigned employees\n   - Child departments (if hierarchy enabled)\n\n### Department Configuration\n\n1. **Active Status**: Only active departments available for new transactions\n2. **Default Account**: Optional default GL account for department expenses\n3. **Multiple Heads**: Departments can have multiple heads\n4. **Head Notifications**: Department heads receive relevant notifications\n\n### Hierarchy Rules (If Implemented)\n\n1. **Parent Department**: Can assign parent for hierarchy\n2. **Circular Prevention**: Cannot create circular hierarchy\n3. **Level Calculation**: Automatic level calculation based on parents\n4. **Rollup**: Budget/expenses can roll up to parent departments\n\n---\n\n## Integration Points\n\n### Account Code Mapping\n\n**Department → GL Account:**\n```\nDepartment Code → Default Account Code → GL Posting\n```\n\n**Mapping Priority:**\n```\n1. Specific category/item mapping\n2. Department default account\n3. Store default account\n```\n\n### User Management\n\n**Department Assignment:**\n- Users assigned to primary department\n- Secondary department assignments\n- Department-based permissions\n- Department head role assignment\n\n### Expense Tracking\n\n**Department Expenses:**\n```\nPurchase Order → Department Code → Budget Tracking\nVendor Invoice → Department → Cost Center Posting\n```\n\n### Budget Management\n\n**Budget Allocation:**\n- Annual budget per department\n- Periodic budget (monthly/quarterly)\n- Budget vs. actual tracking\n- Variance reporting\n\n### Reporting\n\n**Department Reports:**\n- Expense by department\n- Budget variance by department\n- Headcount by department\n- Performance metrics by department\n\n---\n\n## API Endpoints\n\n```http\n# Department Management\nGET /api/finance/departments\nPOST /api/finance/departments\nGET /api/finance/departments/:code\nPUT /api/finance/departments/:code\nDELETE /api/finance/departments/:code\n\n# Department Hierarchy\nGET /api/finance/departments/hierarchy\nGET /api/finance/departments/:code/children\nGET /api/finance/departments/:code/parent\n\n# Department Heads\nPOST /api/finance/departments/:code/heads\nDELETE /api/finance/departments/:code/heads/:email\n\n# Department Budget\nGET /api/finance/departments/:code/budget\nPUT /api/finance/departments/:code/budget\n\n# Department Reporting\nGET /api/finance/departments/:code/expenses\nGET /api/finance/departments/:code/budget-variance\n```\n\n---\n\n## User Guide\n\n### Creating a New Department\n\n1. Navigate to Department List\n2. Click \"New Department\" button\n3. Enter department code (e.g., \"IT\")\n4. Enter department name (e.g., \"Information Technology\")\n5. (Optional) Enter account code\n6. Check \"Active\" if department should be active\n7. Add department head email(s):\n   - Enter email in input field\n   - Click \"Add\" button\n   - Repeat for multiple heads\n8. Click \"Save\"\n\n### Editing an Existing Department\n\n1. Find department in list (use search if needed)\n2. Click Edit icon in Actions column\n3. Modify desired fields\n4. To change heads:\n   - Click \"Remove\" next to existing heads to delete\n   - Add new heads using email input and \"Add\" button\n5. Click \"Save\" to apply changes\n6. Click \"Cancel\" to discard changes\n\n### Deleting a Department\n\n1. Find department in list\n2. Click Delete icon in Actions column\n3. Confirm deletion in dialog\n4. Department will be deleted if no dependencies exist\n\n**Note:** Cannot delete departments with:\n- Active transactions\n- Assigned users\n- Budget allocations\n- Child departments\n\n### Searching for Departments\n\n1. Use search box at top of page\n2. Type department code or name\n3. List filters automatically as you type\n4. Clear search to show all departments\n\n---\n\n## Troubleshooting\n\n### Issue: Cannot Delete Department\n**Cause**: Department has dependencies (transactions, users, budgets)\n**Solution**: Deactivate department instead or reassign dependencies first\n\n### Issue: Duplicate Department Code\n**Cause**: Code already exists in system\n**Solution**: Use a different code or edit existing department\n\n### Issue: Head Email Not Saving\n**Cause**: Invalid email format\n**Solution**: Verify email format is valid (user@domain.com)\n\n### Issue: Department Not Appearing in Dropdowns\n**Cause**: Department is inactive\n**Solution**: Edit department and set Active status to checked\n\n---\n\n## Best Practices\n\n### Department Design\n\n1. **Meaningful Codes**: Use intuitive 2-4 character codes\n2. **Consistent Naming**: Follow naming conventions\n3. **Active Management**: Deactivate unused departments instead of deleting\n4. **Documentation**: Maintain department descriptions\n5. **Hierarchy Planning**: Plan department structure before creating\n\n### Department Heads\n\n1. **Multiple Heads**: Assign backup/secondary heads for coverage\n2. **Email Accuracy**: Verify email addresses are correct\n3. **Role Alignment**: Ensure heads have appropriate system permissions\n4. **Notification Setup**: Configure notifications for department heads\n5. **Regular Review**: Review and update head assignments quarterly\n\n### Account Code Integration\n\n1. **Default Accounts**: Set default accounts for departments\n2. **Expense Categories**: Map common expense categories to departments\n3. **Budget Alignment**: Align account codes with budget structure\n4. **GL Reconciliation**: Regular reconciliation of department expenses\n5. **Cost Center Mapping**: Map departments to GL cost centers\n\n### Data Quality\n\n1. **Regular Audit**: Review department list quarterly\n2. **Inactive Cleanup**: Deactivate unused departments\n3. **Head Validation**: Verify department heads are current\n4. **Account Updates**: Update account codes as GL changes\n5. **Budget Maintenance**: Keep budget allocations current\n\n---\n\n## Reporting\n\n### Available Reports\n\n1. **Department List Report**:\n   - All departments with details\n   - Active vs. inactive count\n   - Department hierarchy view\n\n2. **Department Expense Report**:\n   - Expenses by department\n   - Period comparison\n   - Budget variance\n\n3. **Department Headcount Report**:\n   - Employees by department\n   - Head assignments\n   - Staffing levels\n\n4. **Budget vs. Actual Report**:\n   - Department budget tracking\n   - Variance analysis\n   - Trend visualization\n\n---\n\n## Future Enhancements\n\n**Planned Features:**\n- Department hierarchy visualization\n- Drag-and-drop hierarchy management\n- Budget workflow and approvals\n- Department dashboard with KPIs\n- Automated head notifications\n- Department tags/categories\n- Custom fields per department\n- Department templates\n- Inter-department transfers\n- Department consolidation tools\n\n---\n\n**Last Updated:** 2025-01-17\n**Version:** 1.0.0\n";

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = marked.parse(markdownContent);

        // Function to render Mermaid diagrams
        function renderMermaidDiagrams() {
            if (!window.mermaid) {
                console.log('Mermaid not loaded yet, waiting...');
                return;
            }

            // Find all code blocks with mermaid language
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');

            if (mermaidBlocks.length === 0) {
                console.log('No mermaid blocks found');
                return;
            }

            console.log('Found', mermaidBlocks.length, 'mermaid blocks');

            mermaidBlocks.forEach((block, index) => {
                const mermaidCode = block.textContent;
                const pre = block.parentElement;

                // Create a div for mermaid diagram
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.id = 'mermaid-diagram-' + index;

                // Replace the pre block with mermaid div
                pre.replaceWith(mermaidDiv);
            });

            // Run mermaid rendering
            window.mermaid.run({
                querySelector: '.mermaid'
            }).then(() => {
                console.log('Mermaid diagrams rendered successfully');
            }).catch(err => {
                console.error('Mermaid rendering error:', err);
            });
        }

        // Wait for mermaid to load before rendering
        if (window.mermaidReady) {
            renderMermaidDiagrams();
        } else {
            window.addEventListener('mermaidLoaded', renderMermaidDiagrams);
            // Fallback timeout
            setTimeout(renderMermaidDiagrams, 1000);
        }

        // Generate TOC from headings
        const tocList = document.getElementById('toc-list');
        const headings = contentDiv.querySelectorAll('h2, h3, h4');

        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    tocList.querySelectorAll('a').forEach(a => {
                        a.style.color = a.getAttribute('href') === '#' + id ? 'var(--primary)' : 'var(--text-secondary)';
                        a.style.fontWeight = a.getAttribute('href') === '#' + id ? '600' : '400';
                    });
                }
            });
        }, { threshold: 1.0 });

        headings.forEach(heading => observer.observe(heading));
    </script>
</body>
</html>