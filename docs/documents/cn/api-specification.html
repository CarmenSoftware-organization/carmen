<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Note Module - API Specification - Carmen ERP Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .sidebar nav {
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-section ul {
            list-style: none;
        }

        .nav-section a {
            display: block;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-section a:hover,
        .nav-section a.active {
            background: var(--bg-light);
            color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 280px);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-wrapper {
            display: flex;
            gap: 2rem;
        }

        .document-content {
            flex: 1;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            min-width: 0;
        }

        .toc-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .toc-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list a {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--primary);
        }

        .toc-list .toc-h2 {
            margin-left: 0;
            font-weight: 500;
        }

        .toc-list .toc-h3 {
            margin-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            margin-left: 2rem;
            font-size: 0.75rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        img {
            max-width: 600px;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin: 1rem 0;
            display: block;
        }

        .mermaid {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border);
            max-width: 800px;
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            max-height: 500px;
            height: auto;
            transform: scale(0.85);
            transform-origin: top center;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .toc-sidebar {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // Initialize Mermaid with enhanced configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                background: '#ffffff',
                mainBkg: '#f8fafc',
                secondBkg: '#e2e8f0',
                border1: '#cbd5e1',
                border2: '#94a3b8'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            }
        });

        // Expose mermaid globally and signal it's ready
        window.mermaid = mermaid;
        window.mermaidReady = true;

        // Dispatch event when mermaid is ready
        window.dispatchEvent(new Event('mermaidLoaded'));
    </script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="back-link">‚Üê All Modules</a>
            <h1>Credit Notes</h1>
        </div>

        <nav>
            <div class="nav-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="../index.html">Module Overview</a></li>
                    <li><a href="../index.html#features">Features</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <div class="breadcrumb"><a href="../index.html">Documentation</a> / <a href="../index.html">CN</a></div>

        <div class="content-wrapper">
            <div class="document-content" id="markdown-content"></div>

            <aside class="toc-sidebar">
                <div class="toc-sticky">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const markdownContent = "# Credit Note Module - API Specification\n\nComplete API documentation for the Carmen ERP Credit Note module with endpoints, data models, authentication, and integration patterns.\n\n## Table of Contents\n1. [Authentication & Authorization](#authentication--authorization)\n2. [Core Endpoints](#core-endpoints)\n3. [Data Models](#data-models)\n4. [Error Handling](#error-handling)\n5. [Rate Limiting](#rate-limiting)\n6. [Webhooks](#webhooks)\n7. [Integration Patterns](#integration-patterns)\n\n## Authentication & Authorization\n\n### Authentication Methods\n\n**Bearer Token Authentication**:\n```http\nAuthorization: Bearer <jwt_token>\n```\n\n**API Key Authentication**:\n```http\nX-API-Key: <api_key>\nX-API-Secret: <api_secret>\n```\n\n### Authorization Levels\n\n**Role-based Permissions**:\n- `credit-note:read` - View credit notes\n- `credit-note:create` - Create new credit notes\n- `credit-note:edit` - Modify existing credit notes\n- `credit-note:delete` - Delete credit notes\n- `credit-note:approve` - Approve credit notes\n- `credit-note:process` - Process approved credit notes\n\n**Scope-based Access**:\n- `department:procurement` - Procurement department access\n- `department:finance` - Finance department access\n- `location:specific` - Location-specific access\n- `vendor:specific` - Vendor-specific access\n\n### JWT Token Structure\n```json\n{\n  \"sub\": \"user_id\",\n  \"roles\": [\"procurement_staff\", \"finance_manager\"],\n  \"permissions\": [\"credit-note:read\", \"credit-note:create\"],\n  \"department\": \"procurement\",\n  \"location\": \"main_warehouse\",\n  \"exp\": 1640995200\n}\n```\n\n## Core Endpoints\n\n### 1. Credit Note Management\n\n#### Get All Credit Notes\n```http\nGET /api/v1/credit-notes\n```\n\n**Query Parameters**:\n- `page` (number): Page number (default: 1)\n- `limit` (number): Items per page (default: 20, max: 100)\n- `status` (string): Filter by status (draft, pending_approval, approved, processed)\n- `vendor_id` (string): Filter by vendor ID\n- `date_from` (string): Start date filter (ISO 8601)\n- `date_to` (string): End date filter (ISO 8601)\n- `type` (string): Credit note type (quantity_return, amount_discount)\n- `search` (string): Search in reference number, vendor name, description\n- `sort_by` (string): Sort field (date, amount, vendor_name, status)\n- `sort_order` (string): Sort direction (asc, desc)\n\n**Response**:\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"cn_001\",\n      \"ref_number\": \"CN-2025-001\",\n      \"vendor\": {\n        \"id\": \"vendor_001\",\n        \"name\": \"ACME Corporation\",\n        \"registration_number\": \"BN123456\"\n      },\n      \"type\": \"quantity_return\",\n      \"status\": \"pending_approval\",\n      \"date\": \"2025-01-15T00:00:00Z\",\n      \"currency\": \"MYR\",\n      \"total_amount\": 1250.50,\n      \"items_count\": 3,\n      \"created_at\": \"2025-01-15T10:30:00Z\",\n      \"updated_at\": \"2025-01-15T14:20:00Z\"\n    }\n  ],\n  \"pagination\": {\n    \"current_page\": 1,\n    \"total_pages\": 5,\n    \"total_items\": 95,\n    \"items_per_page\": 20\n  },\n  \"filters\": {\n    \"status\": [\"draft\", \"pending_approval\", \"approved\", \"processed\"],\n    \"vendors\": [{\"id\": \"vendor_001\", \"name\": \"ACME Corporation\"}],\n    \"types\": [\"quantity_return\", \"amount_discount\"]\n  }\n}\n```\n\n#### Get Credit Note by ID\n```http\nGET /api/v1/credit-notes/{id}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"ref_number\": \"CN-2025-001\",\n    \"vendor\": {\n      \"id\": \"vendor_001\",\n      \"name\": \"ACME Corporation\",\n      \"registration_number\": \"BN123456\",\n      \"contact_person\": \"John Doe\",\n      \"email\": \"john@acme.com\"\n    },\n    \"type\": \"quantity_return\",\n    \"status\": \"pending_approval\",\n    \"date\": \"2025-01-15T00:00:00Z\",\n    \"currency\": \"MYR\",\n    \"exchange_rate\": 1.0,\n    \"reason\": \"Quality issues with delivered items\",\n    \"description\": \"Credit note for defective products returned\",\n    \"items\": [\n      {\n        \"id\": \"item_001\",\n        \"product\": {\n          \"id\": \"prod_001\",\n          \"name\": \"Premium Rice 5kg\",\n          \"sku\": \"RICE-PREM-5KG\"\n        },\n        \"quantity\": 10,\n        \"unit_price\": 25.50,\n        \"total_amount\": 255.00,\n        \"reason_code\": \"quality_defect\",\n        \"lot_number\": \"LOT-2025-001\",\n        \"expiry_date\": \"2025-12-31T00:00:00Z\",\n        \"grn_reference\": \"GRN-2025-001\"\n      }\n    ],\n    \"related_grns\": [\"GRN-2025-001\", \"GRN-2025-002\"],\n    \"financial_summary\": {\n      \"subtotal\": 1200.00,\n      \"tax_amount\": 50.50,\n      \"total_amount\": 1250.50\n    },\n    \"workflow\": {\n      \"created_by\": \"user_001\",\n      \"approved_by\": null,\n      \"approval_date\": null,\n      \"processed_by\": null,\n      \"processing_date\": null\n    },\n    \"created_at\": \"2025-01-15T10:30:00Z\",\n    \"updated_at\": \"2025-01-15T14:20:00Z\"\n  }\n}\n```\n\n#### Create Credit Note\n```http\nPOST /api/v1/credit-notes\n```\n\n**Request Body**:\n```json\n{\n  \"vendor_id\": \"vendor_001\",\n  \"type\": \"quantity_return\",\n  \"date\": \"2025-01-15T00:00:00Z\",\n  \"currency\": \"MYR\",\n  \"reason\": \"Quality issues with delivered items\",\n  \"description\": \"Credit note for defective products\",\n  \"items\": [\n    {\n      \"product_id\": \"prod_001\",\n      \"quantity\": 10,\n      \"unit_price\": 25.50,\n      \"reason_code\": \"quality_defect\",\n      \"lot_number\": \"LOT-2025-001\",\n      \"grn_reference\": \"GRN-2025-001\",\n      \"notes\": \"Visible damage on packaging\"\n    }\n  ],\n  \"related_grn_ids\": [\"GRN-2025-001\"]\n}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_002\",\n    \"ref_number\": \"CN-2025-002\",\n    \"status\": \"draft\",\n    \"total_amount\": 255.00,\n    \"created_at\": \"2025-01-15T15:30:00Z\"\n  },\n  \"message\": \"Credit note created successfully\"\n}\n```\n\n#### Update Credit Note\n```http\nPUT /api/v1/credit-notes/{id}\n```\n\n**Request Body**:\n```json\n{\n  \"reason\": \"Updated reason for credit note\",\n  \"description\": \"Updated description\",\n  \"items\": [\n    {\n      \"id\": \"item_001\",\n      \"quantity\": 8,\n      \"unit_price\": 25.50,\n      \"reason_code\": \"partial_damage\"\n    }\n  ]\n}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"ref_number\": \"CN-2025-001\",\n    \"status\": \"draft\",\n    \"total_amount\": 204.00,\n    \"updated_at\": \"2025-01-15T16:45:00Z\"\n  },\n  \"message\": \"Credit note updated successfully\"\n}\n```\n\n#### Delete Credit Note\n```http\nDELETE /api/v1/credit-notes/{id}\n```\n\n**Response**:\n```json\n{\n  \"message\": \"Credit note deleted successfully\",\n  \"deleted_at\": \"2025-01-15T17:00:00Z\"\n}\n```\n\n### 2. Credit Note Workflow\n\n#### Submit for Approval\n```http\nPOST /api/v1/credit-notes/{id}/submit\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"status\": \"pending_approval\",\n    \"submitted_at\": \"2025-01-15T17:30:00Z\",\n    \"submitted_by\": \"user_001\"\n  },\n  \"message\": \"Credit note submitted for approval\"\n}\n```\n\n#### Approve Credit Note\n```http\nPOST /api/v1/credit-notes/{id}/approve\n```\n\n**Request Body**:\n```json\n{\n  \"comments\": \"Approved - valid quality issues documented\"\n}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"status\": \"approved\",\n    \"approved_at\": \"2025-01-16T09:00:00Z\",\n    \"approved_by\": \"manager_001\"\n  },\n  \"message\": \"Credit note approved successfully\"\n}\n```\n\n#### Reject Credit Note\n```http\nPOST /api/v1/credit-notes/{id}/reject\n```\n\n**Request Body**:\n```json\n{\n  \"reason\": \"insufficient_documentation\",\n  \"comments\": \"Please provide quality inspection reports\"\n}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"status\": \"rejected\",\n    \"rejected_at\": \"2025-01-16T09:15:00Z\",\n    \"rejected_by\": \"manager_001\",\n    \"rejection_reason\": \"insufficient_documentation\"\n  },\n  \"message\": \"Credit note rejected\"\n}\n```\n\n#### Process Credit Note\n```http\nPOST /api/v1/credit-notes/{id}/process\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"id\": \"cn_001\",\n    \"status\": \"processed\",\n    \"processed_at\": \"2025-01-16T14:30:00Z\",\n    \"processed_by\": \"finance_001\",\n    \"journal_entry_id\": \"je_001\",\n    \"vendor_balance_updated\": true\n  },\n  \"message\": \"Credit note processed successfully\"\n}\n```\n\n### 3. Credit Note Items\n\n#### Get Credit Note Items\n```http\nGET /api/v1/credit-notes/{id}/items\n```\n\n**Response**:\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"item_001\",\n      \"product\": {\n        \"id\": \"prod_001\",\n        \"name\": \"Premium Rice 5kg\",\n        \"sku\": \"RICE-PREM-5KG\",\n        \"category\": \"Grains & Cereals\"\n      },\n      \"quantity\": 10,\n      \"unit_price\": 25.50,\n      \"total_amount\": 255.00,\n      \"reason_code\": \"quality_defect\",\n      \"reason_description\": \"Quality defect identified\",\n      \"lot_number\": \"LOT-2025-001\",\n      \"expiry_date\": \"2025-12-31T00:00:00Z\",\n      \"grn_reference\": \"GRN-2025-001\",\n      \"notes\": \"Visible damage on packaging\"\n    }\n  ]\n}\n```\n\n#### Add Credit Note Item\n```http\nPOST /api/v1/credit-notes/{id}/items\n```\n\n**Request Body**:\n```json\n{\n  \"product_id\": \"prod_002\",\n  \"quantity\": 5,\n  \"unit_price\": 12.75,\n  \"reason_code\": \"pricing_error\",\n  \"lot_number\": \"LOT-2025-002\",\n  \"notes\": \"Incorrect pricing applied\"\n}\n```\n\n#### Update Credit Note Item\n```http\nPUT /api/v1/credit-notes/{id}/items/{item_id}\n```\n\n#### Delete Credit Note Item\n```http\nDELETE /api/v1/credit-notes/{id}/items/{item_id}\n```\n\n### 4. Document Management\n\n#### Get Credit Note Documents\n```http\nGET /api/v1/credit-notes/{id}/documents\n```\n\n**Response**:\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"doc_001\",\n      \"name\": \"quality_inspection_report.pdf\",\n      \"type\": \"quality_report\",\n      \"size\": 245760,\n      \"mime_type\": \"application/pdf\",\n      \"uploaded_by\": \"user_001\",\n      \"uploaded_at\": \"2025-01-15T16:00:00Z\",\n      \"url\": \"/api/v1/documents/doc_001/download\"\n    }\n  ]\n}\n```\n\n#### Upload Document\n```http\nPOST /api/v1/credit-notes/{id}/documents\nContent-Type: multipart/form-data\n```\n\n**Form Data**:\n- `file`: Document file\n- `type`: Document type (quality_report, vendor_correspondence, photo_evidence)\n- `description`: Document description\n\n#### Download Document\n```http\nGET /api/v1/credit-notes/{id}/documents/{document_id}/download\n```\n\n### 5. Vendor Integration\n\n#### Get Vendor Credit Notes\n```http\nGET /api/v1/vendors/{vendor_id}/credit-notes\n```\n\n#### Get Available GRNs for Vendor\n```http\nGET /api/v1/vendors/{vendor_id}/grns\n```\n\n**Query Parameters**:\n- `status` (string): GRN status filter\n- `date_from` (string): Start date filter\n- `date_to` (string): End date filter\n\n**Response**:\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"grn_001\",\n      \"ref_number\": \"GRN-2025-001\",\n      \"date\": \"2025-01-10T00:00:00Z\",\n      \"total_amount\": 2500.00,\n      \"currency\": \"MYR\",\n      \"items_count\": 5,\n      \"available_for_credit\": true\n    }\n  ]\n}\n```\n\n### 6. Reporting & Analytics\n\n#### Credit Note Summary Report\n```http\nGET /api/v1/credit-notes/reports/summary\n```\n\n**Query Parameters**:\n- `period` (string): Report period (daily, weekly, monthly, yearly)\n- `date_from` (string): Start date\n- `date_to` (string): End date\n- `vendor_id` (string): Vendor filter\n- `type` (string): Credit note type filter\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"summary\": {\n      \"total_credit_notes\": 125,\n      \"total_amount\": 15750.25,\n      \"by_status\": {\n        \"draft\": 5,\n        \"pending_approval\": 8,\n        \"approved\": 12,\n        \"processed\": 100\n      },\n      \"by_type\": {\n        \"quantity_return\": 95,\n        \"amount_discount\": 30\n      }\n    },\n    \"trends\": [\n      {\n        \"period\": \"2025-01\",\n        \"count\": 25,\n        \"amount\": 3125.50\n      }\n    ],\n    \"top_vendors\": [\n      {\n        \"vendor_id\": \"vendor_001\",\n        \"vendor_name\": \"ACME Corporation\",\n        \"credit_notes_count\": 15,\n        \"total_amount\": 2250.75\n      }\n    ]\n  }\n}\n```\n\n#### Export Credit Notes\n```http\nPOST /api/v1/credit-notes/export\n```\n\n**Request Body**:\n```json\n{\n  \"format\": \"xlsx\",\n  \"filters\": {\n    \"status\": [\"approved\", \"processed\"],\n    \"date_from\": \"2025-01-01T00:00:00Z\",\n    \"date_to\": \"2025-01-31T23:59:59Z\"\n  },\n  \"fields\": [\n    \"ref_number\",\n    \"vendor_name\",\n    \"date\",\n    \"type\",\n    \"status\",\n    \"total_amount\"\n  ]\n}\n```\n\n**Response**:\n```json\n{\n  \"data\": {\n    \"export_id\": \"export_001\",\n    \"status\": \"processing\",\n    \"estimated_completion\": \"2025-01-15T18:05:00Z\"\n  }\n}\n```\n\n#### Get Export Status\n```http\nGET /api/v1/exports/{export_id}\n```\n\n## Data Models\n\n### Credit Note Model\n```json\n{\n  \"id\": \"string\",\n  \"ref_number\": \"string\",\n  \"vendor\": {\n    \"id\": \"string\",\n    \"name\": \"string\",\n    \"registration_number\": \"string\",\n    \"contact_person\": \"string\",\n    \"email\": \"string\",\n    \"phone\": \"string\"\n  },\n  \"type\": \"quantity_return | amount_discount\",\n  \"status\": \"draft | pending_approval | approved | rejected | processed | cancelled\",\n  \"date\": \"ISO 8601 datetime\",\n  \"currency\": \"string\",\n  \"exchange_rate\": \"number\",\n  \"reason\": \"string\",\n  \"description\": \"string\",\n  \"items\": [\"CreditNoteItem\"],\n  \"related_grns\": [\"string\"],\n  \"financial_summary\": {\n    \"subtotal\": \"number\",\n    \"tax_amount\": \"number\",\n    \"discount_amount\": \"number\",\n    \"total_amount\": \"number\"\n  },\n  \"workflow\": {\n    \"created_by\": \"string\",\n    \"created_at\": \"ISO 8601 datetime\",\n    \"submitted_by\": \"string\",\n    \"submitted_at\": \"ISO 8601 datetime\",\n    \"approved_by\": \"string\",\n    \"approved_at\": \"ISO 8601 datetime\",\n    \"processed_by\": \"string\",\n    \"processed_at\": \"ISO 8601 datetime\"\n  },\n  \"documents\": [\"Document\"],\n  \"activity_log\": [\"ActivityLogEntry\"],\n  \"created_at\": \"ISO 8601 datetime\",\n  \"updated_at\": \"ISO 8601 datetime\"\n}\n```\n\n### Credit Note Item Model\n```json\n{\n  \"id\": \"string\",\n  \"credit_note_id\": \"string\",\n  \"product\": {\n    \"id\": \"string\",\n    \"name\": \"string\",\n    \"sku\": \"string\",\n    \"category\": \"string\",\n    \"unit\": \"string\"\n  },\n  \"quantity\": \"number\",\n  \"unit_price\": \"number\",\n  \"total_amount\": \"number\",\n  \"reason_code\": \"string\",\n  \"reason_description\": \"string\",\n  \"lot_number\": \"string\",\n  \"expiry_date\": \"ISO 8601 datetime\",\n  \"grn_reference\": \"string\",\n  \"grn_item_id\": \"string\",\n  \"notes\": \"string\",\n  \"created_at\": \"ISO 8601 datetime\",\n  \"updated_at\": \"ISO 8601 datetime\"\n}\n```\n\n### Reason Code Model\n```json\n{\n  \"code\": \"string\",\n  \"category\": \"quality | pricing | quantity | other\",\n  \"description\": \"string\",\n  \"requires_documentation\": \"boolean\",\n  \"automatic_approval\": \"boolean\",\n  \"active\": \"boolean\"\n}\n```\n\n### Document Model\n```json\n{\n  \"id\": \"string\",\n  \"credit_note_id\": \"string\",\n  \"name\": \"string\",\n  \"type\": \"quality_report | vendor_correspondence | photo_evidence | other\",\n  \"description\": \"string\",\n  \"file_path\": \"string\",\n  \"size\": \"number\",\n  \"mime_type\": \"string\",\n  \"uploaded_by\": \"string\",\n  \"uploaded_at\": \"ISO 8601 datetime\",\n  \"download_url\": \"string\"\n}\n```\n\n### Activity Log Entry Model\n```json\n{\n  \"id\": \"string\",\n  \"credit_note_id\": \"string\",\n  \"action\": \"string\",\n  \"description\": \"string\",\n  \"user_id\": \"string\",\n  \"user_name\": \"string\",\n  \"timestamp\": \"ISO 8601 datetime\",\n  \"metadata\": \"object\"\n}\n```\n\n## Error Handling\n\n### Error Response Format\n```json\n{\n  \"error\": {\n    \"code\": \"string\",\n    \"message\": \"string\",\n    \"details\": \"object\",\n    \"timestamp\": \"ISO 8601 datetime\",\n    \"request_id\": \"string\"\n  }\n}\n```\n\n### Common Error Codes\n\n**Client Errors (4xx)**:\n- `400` - Bad Request\n- `401` - Unauthorized\n- `403` - Forbidden\n- `404` - Not Found\n- `409` - Conflict\n- `422` - Unprocessable Entity\n\n**Server Errors (5xx)**:\n- `500` - Internal Server Error\n- `502` - Bad Gateway\n- `503` - Service Unavailable\n- `504` - Gateway Timeout\n\n### Validation Errors\n```json\n{\n  \"error\": {\n    \"code\": \"validation_failed\",\n    \"message\": \"Validation failed for one or more fields\",\n    \"details\": {\n      \"fields\": {\n        \"vendor_id\": [\"Vendor ID is required\"],\n        \"items[0].quantity\": [\"Quantity must be greater than 0\"]\n      }\n    }\n  }\n}\n```\n\n### Business Logic Errors\n```json\n{\n  \"error\": {\n    \"code\": \"insufficient_grn_quantity\",\n    \"message\": \"Credit quantity exceeds available GRN quantity\",\n    \"details\": {\n      \"grn_id\": \"GRN-2025-001\",\n      \"product_id\": \"prod_001\",\n      \"available_quantity\": 50,\n      \"requested_quantity\": 75\n    }\n  }\n}\n```\n\n## Rate Limiting\n\n### Rate Limit Headers\n```http\nX-RateLimit-Limit: 1000\nX-RateLimit-Remaining: 999\nX-RateLimit-Reset: 1640995200\nX-RateLimit-Window: 3600\n```\n\n### Rate Limit Tiers\n- **Standard User**: 1000 requests/hour\n- **Premium User**: 5000 requests/hour\n- **Enterprise**: 10000 requests/hour\n- **System Integration**: 50000 requests/hour\n\n### Rate Limit Exceeded Response\n```json\n{\n  \"error\": {\n    \"code\": \"rate_limit_exceeded\",\n    \"message\": \"Rate limit exceeded. Try again later.\",\n    \"details\": {\n      \"limit\": 1000,\n      \"window\": 3600,\n      \"reset_time\": \"2025-01-15T19:00:00Z\"\n    }\n  }\n}\n```\n\n## Webhooks\n\n### Webhook Events\n\n**Credit Note Events**:\n- `credit_note.created` - New credit note created\n- `credit_note.updated` - Credit note modified\n- `credit_note.submitted` - Submitted for approval\n- `credit_note.approved` - Credit note approved\n- `credit_note.rejected` - Credit note rejected\n- `credit_note.processed` - Credit note processed\n- `credit_note.cancelled` - Credit note cancelled\n\n### Webhook Payload\n```json\n{\n  \"event\": \"credit_note.approved\",\n  \"timestamp\": \"2025-01-16T09:00:00Z\",\n  \"data\": {\n    \"credit_note_id\": \"cn_001\",\n    \"ref_number\": \"CN-2025-001\",\n    \"vendor_id\": \"vendor_001\",\n    \"total_amount\": 1250.50,\n    \"currency\": \"MYR\",\n    \"approved_by\": \"manager_001\",\n    \"approved_at\": \"2025-01-16T09:00:00Z\"\n  },\n  \"metadata\": {\n    \"request_id\": \"req_001\",\n    \"api_version\": \"v1\"\n  }\n}\n```\n\n### Webhook Security\n- **Signature Verification**: HMAC-SHA256 signature in `X-Webhook-Signature` header\n- **Timestamp Validation**: Timestamp in `X-Webhook-Timestamp` header\n- **Retry Logic**: Exponential backoff for failed deliveries\n- **Delivery Confirmation**: 200 status code required for successful delivery\n\n## Integration Patterns\n\n### Vendor Portal Integration\n```http\nGET /api/v1/vendor-portal/credit-notes\nAuthorization: Bearer <vendor_portal_token>\n```\n\n### ERP System Integration\n```http\nPOST /api/v1/integrations/erp/credit-notes/sync\nX-Integration-Key: <erp_integration_key>\n```\n\n### Accounting System Integration\n```http\nPOST /api/v1/integrations/accounting/journal-entries\nContent-Type: application/json\n\n{\n  \"credit_note_id\": \"cn_001\",\n  \"entries\": [\n    {\n      \"account\": \"accounts_payable\",\n      \"debit\": 0,\n      \"credit\": 1250.50\n    },\n    {\n      \"account\": \"inventory_returns\",\n      \"debit\": 1250.50,\n      \"credit\": 0\n    }\n  ]\n}\n```\n\n### Inventory Management Integration\n```http\nPOST /api/v1/integrations/inventory/adjustments\nContent-Type: application/json\n\n{\n  \"credit_note_id\": \"cn_001\",\n  \"adjustments\": [\n    {\n      \"product_id\": \"prod_001\",\n      \"location_id\": \"loc_001\",\n      \"quantity_change\": 10,\n      \"adjustment_type\": \"return\",\n      \"reason\": \"credit_note_return\"\n    }\n  ]\n}\n```\n\n---\n\n*Generated on: 2025-09-23*\n*API Specification Version: 1.0*\n*Carmen ERP - Credit Note Module*";

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = marked.parse(markdownContent);

        // Function to render Mermaid diagrams
        function renderMermaidDiagrams() {
            if (!window.mermaid) {
                console.log('Mermaid not loaded yet, waiting...');
                return;
            }

            // Find all code blocks with mermaid language
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');

            if (mermaidBlocks.length === 0) {
                console.log('No mermaid blocks found');
                return;
            }

            console.log('Found', mermaidBlocks.length, 'mermaid blocks');

            mermaidBlocks.forEach((block, index) => {
                const mermaidCode = block.textContent;
                const pre = block.parentElement;

                // Create a div for mermaid diagram
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.id = 'mermaid-diagram-' + index;

                // Replace the pre block with mermaid div
                pre.replaceWith(mermaidDiv);
            });

            // Run mermaid rendering
            window.mermaid.run({
                querySelector: '.mermaid'
            }).then(() => {
                console.log('Mermaid diagrams rendered successfully');
            }).catch(err => {
                console.error('Mermaid rendering error:', err);
            });
        }

        // Wait for mermaid to load before rendering
        if (window.mermaidReady) {
            renderMermaidDiagrams();
        } else {
            window.addEventListener('mermaidLoaded', renderMermaidDiagrams);
            // Fallback timeout
            setTimeout(renderMermaidDiagrams, 1000);
        }

        // Generate TOC from headings
        const tocList = document.getElementById('toc-list');
        const headings = contentDiv.querySelectorAll('h2, h3, h4');

        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    tocList.querySelectorAll('a').forEach(a => {
                        a.style.color = a.getAttribute('href') === '#' + id ? 'var(--primary)' : 'var(--text-secondary)';
                        a.style.fontWeight = a.getAttribute('href') === '#' + id ? '600' : '400';
                    });
                }
            });
        }, { threshold: 1.0 });

        headings.forEach(heading => observer.observe(heading));
    </script>
</body>
</html>