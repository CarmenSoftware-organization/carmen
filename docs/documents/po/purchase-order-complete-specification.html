<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Module - Complete Technical Specification - Carmen ERP Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-white);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            color: var(--primary);
        }

        .sidebar nav {
            padding: 0 1rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section h3 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }

        .nav-section ul {
            list-style: none;
        }

        .nav-section a {
            display: block;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .nav-section a:hover,
        .nav-section a.active {
            background: var(--bg-light);
            color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 2rem;
            max-width: calc(100% - 280px);
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-wrapper {
            display: flex;
            gap: 2rem;
        }

        .document-content {
            flex: 1;
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            min-width: 0;
        }

        .toc-sidebar {
            width: 250px;
            flex-shrink: 0;
        }

        .toc-sticky {
            position: sticky;
            top: 2rem;
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        .toc-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .toc-list {
            list-style: none;
        }

        .toc-list a {
            display: block;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .toc-list a:hover {
            color: var(--primary);
        }

        .toc-list .toc-h2 {
            margin-left: 0;
            font-weight: 500;
        }

        .toc-list .toc-h3 {
            margin-left: 1rem;
            font-size: 0.8125rem;
        }

        .toc-list .toc-h4 {
            margin-left: 2rem;
            font-size: 0.75rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
            font-style: italic;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 0.75rem;
            text-align: left;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        img {
            max-width: 600px;
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            margin: 1rem 0;
            display: block;
        }

        .mermaid {
            background: var(--bg-white);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            border: 1px solid var(--border);
            max-width: 800px;
            overflow-x: auto;
        }

        .mermaid svg {
            max-width: 100%;
            max-height: 500px;
            height: auto;
            transform: scale(0.85);
            transform-origin: top center;
        }

        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
            }

            .toc-sidebar {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // Initialize Mermaid with enhanced configuration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#2563eb',
                primaryTextColor: '#0f172a',
                primaryBorderColor: '#1e40af',
                lineColor: '#64748b',
                secondaryColor: '#10b981',
                tertiaryColor: '#f59e0b',
                background: '#ffffff',
                mainBkg: '#f8fafc',
                secondBkg: '#e2e8f0',
                border1: '#cbd5e1',
                border2: '#94a3b8'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            },
            gantt: {
                useMaxWidth: true
            }
        });

        // Expose mermaid globally and signal it's ready
        window.mermaid = mermaid;
        window.mermaidReady = true;

        // Dispatch event when mermaid is ready
        window.dispatchEvent(new Event('mermaidLoaded'));
    </script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="back-link">← All Modules</a>
            <h1>Purchase Orders</h1>
        </div>

        <nav>
            <div class="nav-section">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="../index.html">Module Overview</a></li>
                    <li><a href="../index.html#features">Features</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <div class="breadcrumb"><a href="../index.html">Documentation</a> / <a href="../index.html">PO</a></div>

        <div class="content-wrapper">
            <div class="document-content" id="markdown-content"></div>

            <aside class="toc-sidebar">
                <div class="toc-sticky">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list" id="toc-list"></ul>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const markdownContent = "# Purchase Order Module - Complete Technical Specification\n\n## Table of Contents\n1. [Module Overview](#module-overview)\n2. [Site Map](#site-map)\n3. [Pages & Components](#pages--components)\n4. [Data Flow](#data-flow)\n5. [User Interactions](#user-interactions)\n6. [Technical Architecture](#technical-architecture)\n7. [API Endpoints](#api-endpoints)\n8. [Database Schema](#database-schema)\n\n## Module Overview\n\nThe Purchase Order (PO) module is a comprehensive procurement management system within the Carmen Hospitality ERP. It handles the complete lifecycle of purchase orders from creation to fulfillment, including multi-currency support, vendor management, and integration with Purchase Requests (PR) and Goods Received Notes (GRN).\n\n### Key Features\n- Purchase Order lifecycle management (Draft → Sent → Received → Closed)\n- Multi-currency support with real-time exchange rates\n- Integration with Purchase Requests for seamless procurement flow\n- Comprehensive item management with inventory tracking\n- Document management (attachments, comments, related documents)\n- Advanced filtering and search capabilities\n- Export and print functionality\n- Activity logging and audit trail\n- Bulk operations and template support\n\n## Site Map\n\n```mermaid\ngraph TD\n    A[Purchase Orders Landing Page] --> B[PO List View]\n    A --> C[PO Card View]\n\n    B --> D[New PO Dropdown Menu]\n    D --> E[Create Blank PO]\n    D --> F[Create from Purchase Requests]\n    D --> G[Create from Template]\n    D --> H[Create Recurring PO]\n\n    B --> I[PO Detail Page]\n    I --> J[Items Tab]\n    I --> K[Documents Tab]\n    I --> L[Activity Log Sidebar]\n\n    J --> M[Enhanced Items Table]\n    M --> N[Item Details Panel]\n    M --> O[Add Item Dialog]\n    M --> P[Edit Item Dialog]\n\n    K --> Q[Related Documents Table]\n    Q --> R[GRN Links]\n    Q --> S[Credit Note Links]\n    Q --> T[Invoice Links]\n\n    I --> U[Action Buttons]\n    U --> V[Edit Mode]\n    U --> W[Delete Dialog]\n    U --> X[Print Options]\n    U --> Y[Email Dialog]\n    U --> Z[Export Dialog]\n\n    F --> AA[PR Selection Dialog]\n    AA --> AB[PR Items Table]\n    AB --> AC[Grouped PO Creation]\n\n    E --> AD[PO Creation Form]\n    AD --> AE[Vendor Selection]\n    AD --> AF[Currency Selection]\n    AD --> AG[Terms & Conditions]\n\n    I --> AH[Status Change Dialog]\n    AH --> AI[Status Confirmation]\n    AH --> AJ[Reason Input]\n\n    B --> AK[Advanced Filters]\n    AK --> AL[Status Filter]\n    AK --> AM[Date Range Filter]\n    AK --> AN[Vendor Filter]\n    AK --> AO[Amount Range Filter]\n\n    B --> AP[Bulk Actions]\n    AP --> AQ[Bulk Export]\n    AP --> AR[Bulk Print]\n    AP --> AS[Bulk Status Update]\n```\n\n## Pages & Components\n\n### 1. Purchase Orders Landing Page (`/procurement/purchase-orders`)\n\n**File:** `app/(main)/procurement/purchase-orders/page.tsx`\n\n**Components Used:**\n- `PurchaseOrdersDataTable`\n- `PurchaseOrderCardView`\n- `CreatePOFromPR` (Dialog)\n- `purchaseOrderColumns`\n\n**Features:**\n- Responsive data table with sorting and filtering\n- Toggle between table and card views\n- Search functionality\n- New PO dropdown menu with multiple creation options\n- Export and print functionality\n- Bulk selection and actions\n\n**Screenshots:**\n- ![PO List Page](./screenshots/purchase-orders-list-page.png)\n- ![New PO Menu](./screenshots/purchase-order-new-po-menu.png)\n\n### 2. Purchase Order Detail Page (`/procurement/purchase-orders/[id]`)\n\n**File:** `app/(main)/procurement/purchase-orders/components/PODetailPage.tsx`\n\n**Sub-components:**\n- `EnhancedItemsTab` - Items management with advanced features\n- `RelatedDocumentsTab` - Related GRN, invoices, credit notes\n- `ActivityLogTab` - Complete audit trail\n- `TransactionSummary` - Financial calculations\n- `StatusBadge` - Dynamic status indicator\n\n**Features:**\n- Comprehensive PO header information with editable fields\n- Two-tab interface (Items and Documents)\n- Collapsible activity log sidebar\n- Real-time financial calculations\n- Status change workflow with validation\n- Multiple action buttons (Edit, Delete, Print, Email, Export)\n\n**Screenshots:**\n- ![PO Detail Page - Items Tab](./screenshots/purchase-order-detail-page.png)\n- ![PO Detail Page - Documents Tab](./screenshots/purchase-order-documents-tab.png)\n\n### 3. Purchase Order Creation Pages\n\n#### 3.1 Create Blank PO (`/procurement/purchase-orders/create`)\n**File:** `app/(main)/procurement/purchase-orders/create/page.tsx`\n- Redirects to PODetailPage with `id: 'new'`\n- Fresh form with empty fields\n- Add items manually\n\n#### 3.2 Create from Purchase Requests (`/procurement/purchase-orders/create/from-pr`)\n**File:** `app/(main)/procurement/purchase-orders/create/from-pr/page.tsx`\n- PR selection interface\n- Automatic grouping by vendor and currency\n- Item aggregation and validation\n\n#### 3.3 Bulk PO Creation (`/procurement/purchase-orders/create/bulk`)\n**File:** `app/(main)/procurement/purchase-orders/create/bulk/page.tsx`\n- Multiple PO creation from grouped PRs\n- Batch processing interface\n\n## Data Flow\n\n### Purchase Order Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> Draft\n    Draft --> Sent\n    Sent --> PartiallyReceived\n    Sent --> FullyReceived\n    PartiallyReceived --> FullyReceived\n    FullyReceived --> Closed\n    Draft --> Voided\n    Sent --> Cancelled\n    PartiallyReceived --> Cancelled\n    Cancelled --> [*]\n    Voided --> [*]\n    Closed --> [*]\n```\n\n### Component Data Flow\n\n```mermaid\nflowchart TD\n    A[Mock Data Store] --> B[PO List Page]\n    B --> C[PO Detail Page]\n    C --> D[Items Tab]\n    C --> E[Documents Tab]\n    C --> F[Activity Log]\n\n    D --> G[Item Management]\n    G --> H[Add Item]\n    G --> I[Edit Item]\n    G --> J[Delete Item]\n\n    H --> K[Item Form Dialog]\n    I --> K\n\n    E --> L[Related Documents]\n    L --> M[GRN Navigation]\n    L --> N[Credit Note Navigation]\n\n    F --> O[Status Changes]\n    F --> P[User Actions]\n    F --> Q[System Events]\n\n    C --> R[Status Change Dialog]\n    R --> S[Confirmation]\n    S --> T[Activity Log Update]\n\n    C --> U[Export Dialog]\n    U --> V[Format Selection]\n    U --> W[Section Selection]\n```\n\n## User Interactions\n\n### Primary User Flows\n\n#### 1. Create Purchase Order from Scratch\n1. Navigate to PO List page\n2. Click \"New PO\" → \"Create Blank PO\"\n3. Fill vendor and header information\n4. Add items manually or from catalog\n5. Set pricing, quantities, and terms\n6. Save as Draft or Send to vendor\n\n#### 2. Create Purchase Order from Purchase Requests\n1. Navigate to PO List page\n2. Click \"New PO\" → \"Create from Purchase Requests\"\n3. Select approved PRs from dialog\n4. System groups by vendor and currency\n5. Review and modify grouped items\n6. Generate one or multiple POs\n\n#### 3. Process Purchase Order Items\n1. Open PO Detail page\n2. Navigate to Items tab\n3. Review ordered vs received quantities\n4. Process goods receipt (links to GRN)\n5. Handle partial deliveries\n6. Close completed line items\n\n#### 4. Document Management\n1. Open PO Detail page\n2. Navigate to Documents tab\n3. View related GRNs, invoices, credit notes\n4. Access linked documents\n5. Track document status and amounts\n\n### Dialog & Modal Interactions\n\n#### Status Change Dialog\n- **Trigger:** Status dropdown change\n- **Validation:** Requires reason for cancellation/void\n- **Action:** Updates status with audit trail\n- **Confirmation:** Prevents accidental status changes\n\n#### Export Dialog\n- **Format Options:** PDF, Excel, CSV\n- **Section Selection:** Header, Items, Financial Summary, Vendor Info, Comments\n- **Preview:** Shows selected sections\n- **Download:** Generates and downloads file\n\n#### Create from PR Dialog\n- **Search & Filter:** Find relevant PRs\n- **Multi-selection:** Choose multiple PRs\n- **Grouping Preview:** Shows how POs will be created\n- **Validation:** Ensures approved PRs only\n\n## Technical Architecture\n\n### Component Hierarchy\n\n```\nPurchaseOrdersPage\n├── PurchaseOrdersDataTable\n│   ├── DataTable (shadcn/ui)\n│   ├── purchaseOrderColumns\n│   └── TableToolbar\n├── PurchaseOrderCardView\n└── CreatePOFromPR (Dialog)\n\nPODetailPage\n├── DetailPageTemplate\n├── StatusBadge\n├── TransactionSummary\n├── Tabs\n│   ├── EnhancedItemsTab\n│   │   ├── ItemDetailsComponent\n│   │   ├── EnhancedPOItemRow\n│   │   └── AddItemDialog\n│   └── RelatedDocumentsTab\n└── ActivityLogTab\n```\n\n### State Management\n\n**Local State (React useState):**\n- `viewMode`: Table vs Card view toggle\n- `selectedPOs`: Multi-selection state\n- `showCreateFromPRDialog`: Dialog visibility\n- `poData`: Current PO being viewed/edited\n- `isEditing`: Edit mode toggle\n- `showDeleteDialog`: Delete confirmation\n- `statusHistory`: Activity log entries\n\n**URL State:**\n- `id`: PO identifier\n- Query parameters for creation mode (`fromPR`, `grouped`, `bulk`)\n\n**Local Storage:**\n- `groupedPurchaseRequests`: Temporary storage for PR → PO conversion\n- `selectedPurchaseRequests`: Selected PRs for PO creation\n\n### Data Types\n\n```typescript\ninterface PurchaseOrder {\n  poId: string\n  number: string\n  vendorId: number\n  vendorName: string\n  orderDate: Date\n  status: PurchaseOrderStatus\n  currencyCode: string\n  baseCurrencyCode: string\n  exchangeRate: number\n  items: PurchaseOrderItem[]\n  // ... additional fields\n}\n\ninterface PurchaseOrderItem {\n  id: string\n  name: string\n  description: string\n  orderedQuantity: number\n  receivedQuantity: number\n  unitPrice: number\n  taxRate: number\n  discountRate: number\n  // ... additional fields\n}\n```\n\n## API Endpoints\n\n### Purchase Orders\n- `GET /api/purchase-orders` - List all POs with filtering\n- `GET /api/purchase-orders/{id}` - Get specific PO\n- `POST /api/purchase-orders` - Create new PO\n- `PUT /api/purchase-orders/{id}` - Update PO\n- `DELETE /api/purchase-orders/{id}` - Delete PO\n- `PATCH /api/purchase-orders/{id}/status` - Update PO status\n\n### Items Management\n- `POST /api/purchase-orders/{id}/items` - Add item to PO\n- `PUT /api/purchase-orders/{id}/items/{itemId}` - Update item\n- `DELETE /api/purchase-orders/{id}/items/{itemId}` - Remove item\n\n### Document Actions\n- `GET /api/purchase-orders/{id}/export` - Export PO\n- `POST /api/purchase-orders/{id}/email` - Email PO to vendor\n- `GET /api/purchase-orders/{id}/related-documents` - Get related docs\n\n### Bulk Operations\n- `POST /api/purchase-orders/bulk-create` - Create multiple POs\n- `POST /api/purchase-orders/bulk-export` - Export multiple POs\n- `PATCH /api/purchase-orders/bulk-status` - Update multiple PO statuses\n\n## Database Schema\n\n### Purchase Orders Table\n```sql\nCREATE TABLE purchase_orders (\n  po_id VARCHAR(20) PRIMARY KEY,\n  number VARCHAR(50) UNIQUE NOT NULL,\n  vendor_id INTEGER NOT NULL,\n  vendor_name VARCHAR(255) NOT NULL,\n  order_date DATE NOT NULL,\n  delivery_date DATE,\n  status VARCHAR(20) NOT NULL,\n  currency_code VARCHAR(3) NOT NULL,\n  base_currency_code VARCHAR(3) NOT NULL,\n  exchange_rate DECIMAL(10,4) DEFAULT 1,\n  credit_terms VARCHAR(100),\n  description TEXT,\n  remarks TEXT,\n  sub_total_price DECIMAL(15,2) DEFAULT 0,\n  discount_amount DECIMAL(15,2) DEFAULT 0,\n  tax_amount DECIMAL(15,2) DEFAULT 0,\n  total_amount DECIMAL(15,2) DEFAULT 0,\n  created_by INTEGER NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n### Purchase Order Items Table\n```sql\nCREATE TABLE purchase_order_items (\n  id VARCHAR(36) PRIMARY KEY,\n  po_id VARCHAR(20) NOT NULL,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  ordered_quantity DECIMAL(10,3) NOT NULL,\n  received_quantity DECIMAL(10,3) DEFAULT 0,\n  order_unit VARCHAR(20) NOT NULL,\n  unit_price DECIMAL(15,4) NOT NULL,\n  tax_rate DECIMAL(5,2) DEFAULT 0,\n  discount_rate DECIMAL(5,2) DEFAULT 0,\n  sub_total_price DECIMAL(15,2) NOT NULL,\n  discount_amount DECIMAL(15,2) DEFAULT 0,\n  tax_amount DECIMAL(15,2) DEFAULT 0,\n  total_amount DECIMAL(15,2) NOT NULL,\n  status VARCHAR(20) DEFAULT 'Open',\n  source_pr_id VARCHAR(20),\n  source_pr_number VARCHAR(50),\n  FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id)\n);\n```\n\n### Activity Log Table\n```sql\nCREATE TABLE po_activity_log (\n  id VARCHAR(36) PRIMARY KEY,\n  po_id VARCHAR(20) NOT NULL,\n  user_id INTEGER NOT NULL,\n  user_name VARCHAR(255) NOT NULL,\n  action VARCHAR(100) NOT NULL,\n  activity_type VARCHAR(50) NOT NULL,\n  description TEXT,\n  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id)\n);\n```\n\n---\n\n*Generated on: $(date)*\n*Module Version: 1.0*\n*Last Updated: Latest*";

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = marked.parse(markdownContent);

        // Function to render Mermaid diagrams
        function renderMermaidDiagrams() {
            if (!window.mermaid) {
                console.log('Mermaid not loaded yet, waiting...');
                return;
            }

            // Find all code blocks with mermaid language
            const mermaidBlocks = contentDiv.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');

            if (mermaidBlocks.length === 0) {
                console.log('No mermaid blocks found');
                return;
            }

            console.log('Found', mermaidBlocks.length, 'mermaid blocks');

            mermaidBlocks.forEach((block, index) => {
                const mermaidCode = block.textContent;
                const pre = block.parentElement;

                // Create a div for mermaid diagram
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = mermaidCode;
                mermaidDiv.id = 'mermaid-diagram-' + index;

                // Replace the pre block with mermaid div
                pre.replaceWith(mermaidDiv);
            });

            // Run mermaid rendering
            window.mermaid.run({
                querySelector: '.mermaid'
            }).then(() => {
                console.log('Mermaid diagrams rendered successfully');
            }).catch(err => {
                console.error('Mermaid rendering error:', err);
            });
        }

        // Wait for mermaid to load before rendering
        if (window.mermaidReady) {
            renderMermaidDiagrams();
        } else {
            window.addEventListener('mermaidLoaded', renderMermaidDiagrams);
            // Fallback timeout
            setTimeout(renderMermaidDiagrams, 1000);
        }

        // Generate TOC from headings
        const tocList = document.getElementById('toc-list');
        const headings = contentDiv.querySelectorAll('h2, h3, h4');

        headings.forEach((heading, index) => {
            const id = 'heading-' + index;
            heading.id = id;

            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();

            li.appendChild(a);
            tocList.appendChild(li);
        });

        // Highlight active TOC item on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    tocList.querySelectorAll('a').forEach(a => {
                        a.style.color = a.getAttribute('href') === '#' + id ? 'var(--primary)' : 'var(--text-secondary)';
                        a.style.fontWeight = a.getAttribute('href') === '#' + id ? '600' : '400';
                    });
                }
            });
        }, { threshold: 1.0 });

        headings.forEach(heading => observer.observe(heading));
    </script>
</body>
</html>