<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Module - Complete Technical Specification - Carmen ERP Documentation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/marked-mermaid@latest/dist/css/marked-mermaid.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .back-link {
            display: inline-block;
            color: var(--primary);
            text-decoration: none;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .content {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-primary);
        }

        h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        h4 {
            font-size: 1.125rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 1rem;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        code {
            background: var(--bg-light);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        pre {
            background: var(--text-primary);
            color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        ul, ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        li {
            margin: 0.5rem 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
        }

        blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            color: var(--text-secondary);
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .mermaid {
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section-badge">Application Modules</div>
        <div class="breadcrumb"><a href="../../index.html">Documentation</a> / <a href="../index.html">Application Modules</a> / Procurement / Purchase Orders</div>
        <a href="../../index.html" class="back-link">← Back to Documentation Home</a>
        <div class="content" id="markdown-content"></div>
    </div>
    <script>
        const markdownContent = "# Purchase Order Module - Complete Technical Specification\n\n## Table of Contents\n1. [Module Overview](#module-overview)\n2. [Site Map](#site-map)\n3. [Pages & Components](#pages--components)\n4. [Data Flow](#data-flow)\n5. [User Interactions](#user-interactions)\n6. [Technical Architecture](#technical-architecture)\n7. [API Endpoints](#api-endpoints)\n8. [Database Schema](#database-schema)\n\n## Module Overview\n\nThe Purchase Order (PO) module is a comprehensive procurement management system within the Carmen Hospitality ERP. It handles the complete lifecycle of purchase orders from creation to fulfillment, including multi-currency support, vendor management, and integration with Purchase Requests (PR) and Goods Received Notes (GRN).\n\n### Key Features\n- Purchase Order lifecycle management (Draft → Sent → Received → Closed)\n- Multi-currency support with real-time exchange rates\n- Integration with Purchase Requests for seamless procurement flow\n- Comprehensive item management with inventory tracking\n- Document management (attachments, comments, related documents)\n- Advanced filtering and search capabilities\n- Export and print functionality\n- Activity logging and audit trail\n- Bulk operations and template support\n\n## Site Map\n\n```mermaid\ngraph TD\n    A[Purchase Orders Landing Page] --> B[PO List View]\n    A --> C[PO Card View]\n\n    B --> D[New PO Dropdown Menu]\n    D --> E[Create Blank PO]\n    D --> F[Create from Purchase Requests]\n    D --> G[Create from Template]\n    D --> H[Create Recurring PO]\n\n    B --> I[PO Detail Page]\n    I --> J[Items Tab]\n    I --> K[Documents Tab]\n    I --> L[Activity Log Sidebar]\n\n    J --> M[Enhanced Items Table]\n    M --> N[Item Details Panel]\n    M --> O[Add Item Dialog]\n    M --> P[Edit Item Dialog]\n\n    K --> Q[Related Documents Table]\n    Q --> R[GRN Links]\n    Q --> S[Credit Note Links]\n    Q --> T[Invoice Links]\n\n    I --> U[Action Buttons]\n    U --> V[Edit Mode]\n    U --> W[Delete Dialog]\n    U --> X[Print Options]\n    U --> Y[Email Dialog]\n    U --> Z[Export Dialog]\n\n    F --> AA[PR Selection Dialog]\n    AA --> AB[PR Items Table]\n    AB --> AC[Grouped PO Creation]\n\n    E --> AD[PO Creation Form]\n    AD --> AE[Vendor Selection]\n    AD --> AF[Currency Selection]\n    AD --> AG[Terms & Conditions]\n\n    I --> AH[Status Change Dialog]\n    AH --> AI[Status Confirmation]\n    AH --> AJ[Reason Input]\n\n    B --> AK[Advanced Filters]\n    AK --> AL[Status Filter]\n    AK --> AM[Date Range Filter]\n    AK --> AN[Vendor Filter]\n    AK --> AO[Amount Range Filter]\n\n    B --> AP[Bulk Actions]\n    AP --> AQ[Bulk Export]\n    AP --> AR[Bulk Print]\n    AP --> AS[Bulk Status Update]\n```\n\n## Pages & Components\n\n### 1. Purchase Orders Landing Page (`/procurement/purchase-orders`)\n\n**File:** `app/(main)/procurement/purchase-orders/page.tsx`\n\n**Components Used:**\n- `PurchaseOrdersDataTable`\n- `PurchaseOrderCardView`\n- `CreatePOFromPR` (Dialog)\n- `purchaseOrderColumns`\n\n**Features:**\n- Responsive data table with sorting and filtering\n- Toggle between table and card views\n- Search functionality\n- New PO dropdown menu with multiple creation options\n- Export and print functionality\n- Bulk selection and actions\n\n**Screenshots:**\n- ![PO List Page](./screenshots/purchase-orders-list-page.png)\n- ![New PO Menu](./screenshots/purchase-order-new-po-menu.png)\n\n### 2. Purchase Order Detail Page (`/procurement/purchase-orders/[id]`)\n\n**File:** `app/(main)/procurement/purchase-orders/components/PODetailPage.tsx`\n\n**Sub-components:**\n- `EnhancedItemsTab` - Items management with advanced features\n- `RelatedDocumentsTab` - Related GRN, invoices, credit notes\n- `ActivityLogTab` - Complete audit trail\n- `TransactionSummary` - Financial calculations\n- `StatusBadge` - Dynamic status indicator\n\n**Features:**\n- Comprehensive PO header information with editable fields\n- Two-tab interface (Items and Documents)\n- Collapsible activity log sidebar\n- Real-time financial calculations\n- Status change workflow with validation\n- Multiple action buttons (Edit, Delete, Print, Email, Export)\n\n**Screenshots:**\n- ![PO Detail Page - Items Tab](./screenshots/purchase-order-detail-page.png)\n- ![PO Detail Page - Documents Tab](./screenshots/purchase-order-documents-tab.png)\n\n### 3. Purchase Order Creation Pages\n\n#### 3.1 Create Blank PO (`/procurement/purchase-orders/create`)\n**File:** `app/(main)/procurement/purchase-orders/create/page.tsx`\n- Redirects to PODetailPage with `id: 'new'`\n- Fresh form with empty fields\n- Add items manually\n\n#### 3.2 Create from Purchase Requests (`/procurement/purchase-orders/create/from-pr`)\n**File:** `app/(main)/procurement/purchase-orders/create/from-pr/page.tsx`\n- PR selection interface\n- Automatic grouping by vendor and currency\n- Item aggregation and validation\n\n#### 3.3 Bulk PO Creation (`/procurement/purchase-orders/create/bulk`)\n**File:** `app/(main)/procurement/purchase-orders/create/bulk/page.tsx`\n- Multiple PO creation from grouped PRs\n- Batch processing interface\n\n## Data Flow\n\n### Purchase Order Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> Draft\n    Draft --> Sent\n    Sent --> PartiallyReceived\n    Sent --> FullyReceived\n    PartiallyReceived --> FullyReceived\n    FullyReceived --> Closed\n    Draft --> Voided\n    Sent --> Cancelled\n    PartiallyReceived --> Cancelled\n    Cancelled --> [*]\n    Voided --> [*]\n    Closed --> [*]\n```\n\n### Component Data Flow\n\n```mermaid\nflowchart TD\n    A[Mock Data Store] --> B[PO List Page]\n    B --> C[PO Detail Page]\n    C --> D[Items Tab]\n    C --> E[Documents Tab]\n    C --> F[Activity Log]\n\n    D --> G[Item Management]\n    G --> H[Add Item]\n    G --> I[Edit Item]\n    G --> J[Delete Item]\n\n    H --> K[Item Form Dialog]\n    I --> K\n\n    E --> L[Related Documents]\n    L --> M[GRN Navigation]\n    L --> N[Credit Note Navigation]\n\n    F --> O[Status Changes]\n    F --> P[User Actions]\n    F --> Q[System Events]\n\n    C --> R[Status Change Dialog]\n    R --> S[Confirmation]\n    S --> T[Activity Log Update]\n\n    C --> U[Export Dialog]\n    U --> V[Format Selection]\n    U --> W[Section Selection]\n```\n\n## User Interactions\n\n### Primary User Flows\n\n#### 1. Create Purchase Order from Scratch\n1. Navigate to PO List page\n2. Click \"New PO\" → \"Create Blank PO\"\n3. Fill vendor and header information\n4. Add items manually or from catalog\n5. Set pricing, quantities, and terms\n6. Save as Draft or Send to vendor\n\n#### 2. Create Purchase Order from Purchase Requests\n1. Navigate to PO List page\n2. Click \"New PO\" → \"Create from Purchase Requests\"\n3. Select approved PRs from dialog\n4. System groups by vendor and currency\n5. Review and modify grouped items\n6. Generate one or multiple POs\n\n#### 3. Process Purchase Order Items\n1. Open PO Detail page\n2. Navigate to Items tab\n3. Review ordered vs received quantities\n4. Process goods receipt (links to GRN)\n5. Handle partial deliveries\n6. Close completed line items\n\n#### 4. Document Management\n1. Open PO Detail page\n2. Navigate to Documents tab\n3. View related GRNs, invoices, credit notes\n4. Access linked documents\n5. Track document status and amounts\n\n### Dialog & Modal Interactions\n\n#### Status Change Dialog\n- **Trigger:** Status dropdown change\n- **Validation:** Requires reason for cancellation/void\n- **Action:** Updates status with audit trail\n- **Confirmation:** Prevents accidental status changes\n\n#### Export Dialog\n- **Format Options:** PDF, Excel, CSV\n- **Section Selection:** Header, Items, Financial Summary, Vendor Info, Comments\n- **Preview:** Shows selected sections\n- **Download:** Generates and downloads file\n\n#### Create from PR Dialog\n- **Search & Filter:** Find relevant PRs\n- **Multi-selection:** Choose multiple PRs\n- **Grouping Preview:** Shows how POs will be created\n- **Validation:** Ensures approved PRs only\n\n## Technical Architecture\n\n### Component Hierarchy\n\n```\nPurchaseOrdersPage\n├── PurchaseOrdersDataTable\n│   ├── DataTable (shadcn/ui)\n│   ├── purchaseOrderColumns\n│   └── TableToolbar\n├── PurchaseOrderCardView\n└── CreatePOFromPR (Dialog)\n\nPODetailPage\n├── DetailPageTemplate\n├── StatusBadge\n├── TransactionSummary\n├── Tabs\n│   ├── EnhancedItemsTab\n│   │   ├── ItemDetailsComponent\n│   │   ├── EnhancedPOItemRow\n│   │   └── AddItemDialog\n│   └── RelatedDocumentsTab\n└── ActivityLogTab\n```\n\n### State Management\n\n**Local State (React useState):**\n- `viewMode`: Table vs Card view toggle\n- `selectedPOs`: Multi-selection state\n- `showCreateFromPRDialog`: Dialog visibility\n- `poData`: Current PO being viewed/edited\n- `isEditing`: Edit mode toggle\n- `showDeleteDialog`: Delete confirmation\n- `statusHistory`: Activity log entries\n\n**URL State:**\n- `id`: PO identifier\n- Query parameters for creation mode (`fromPR`, `grouped`, `bulk`)\n\n**Local Storage:**\n- `groupedPurchaseRequests`: Temporary storage for PR → PO conversion\n- `selectedPurchaseRequests`: Selected PRs for PO creation\n\n### Data Types\n\n```typescript\ninterface PurchaseOrder {\n  poId: string\n  number: string\n  vendorId: number\n  vendorName: string\n  orderDate: Date\n  status: PurchaseOrderStatus\n  currencyCode: string\n  baseCurrencyCode: string\n  exchangeRate: number\n  items: PurchaseOrderItem[]\n  // ... additional fields\n}\n\ninterface PurchaseOrderItem {\n  id: string\n  name: string\n  description: string\n  orderedQuantity: number\n  receivedQuantity: number\n  unitPrice: number\n  taxRate: number\n  discountRate: number\n  // ... additional fields\n}\n```\n\n## API Endpoints\n\n### Purchase Orders\n- `GET /api/purchase-orders` - List all POs with filtering\n- `GET /api/purchase-orders/{id}` - Get specific PO\n- `POST /api/purchase-orders` - Create new PO\n- `PUT /api/purchase-orders/{id}` - Update PO\n- `DELETE /api/purchase-orders/{id}` - Delete PO\n- `PATCH /api/purchase-orders/{id}/status` - Update PO status\n\n### Items Management\n- `POST /api/purchase-orders/{id}/items` - Add item to PO\n- `PUT /api/purchase-orders/{id}/items/{itemId}` - Update item\n- `DELETE /api/purchase-orders/{id}/items/{itemId}` - Remove item\n\n### Document Actions\n- `GET /api/purchase-orders/{id}/export` - Export PO\n- `POST /api/purchase-orders/{id}/email` - Email PO to vendor\n- `GET /api/purchase-orders/{id}/related-documents` - Get related docs\n\n### Bulk Operations\n- `POST /api/purchase-orders/bulk-create` - Create multiple POs\n- `POST /api/purchase-orders/bulk-export` - Export multiple POs\n- `PATCH /api/purchase-orders/bulk-status` - Update multiple PO statuses\n\n## Database Schema\n\n### Purchase Orders Table\n```sql\nCREATE TABLE purchase_orders (\n  po_id VARCHAR(20) PRIMARY KEY,\n  number VARCHAR(50) UNIQUE NOT NULL,\n  vendor_id INTEGER NOT NULL,\n  vendor_name VARCHAR(255) NOT NULL,\n  order_date DATE NOT NULL,\n  delivery_date DATE,\n  status VARCHAR(20) NOT NULL,\n  currency_code VARCHAR(3) NOT NULL,\n  base_currency_code VARCHAR(3) NOT NULL,\n  exchange_rate DECIMAL(10,4) DEFAULT 1,\n  credit_terms VARCHAR(100),\n  description TEXT,\n  remarks TEXT,\n  sub_total_price DECIMAL(15,2) DEFAULT 0,\n  discount_amount DECIMAL(15,2) DEFAULT 0,\n  tax_amount DECIMAL(15,2) DEFAULT 0,\n  total_amount DECIMAL(15,2) DEFAULT 0,\n  created_by INTEGER NOT NULL,\n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n### Purchase Order Items Table\n```sql\nCREATE TABLE purchase_order_items (\n  id VARCHAR(36) PRIMARY KEY,\n  po_id VARCHAR(20) NOT NULL,\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  ordered_quantity DECIMAL(10,3) NOT NULL,\n  received_quantity DECIMAL(10,3) DEFAULT 0,\n  order_unit VARCHAR(20) NOT NULL,\n  unit_price DECIMAL(15,4) NOT NULL,\n  tax_rate DECIMAL(5,2) DEFAULT 0,\n  discount_rate DECIMAL(5,2) DEFAULT 0,\n  sub_total_price DECIMAL(15,2) NOT NULL,\n  discount_amount DECIMAL(15,2) DEFAULT 0,\n  tax_amount DECIMAL(15,2) DEFAULT 0,\n  total_amount DECIMAL(15,2) NOT NULL,\n  status VARCHAR(20) DEFAULT 'Open',\n  source_pr_id VARCHAR(20),\n  source_pr_number VARCHAR(50),\n  FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id)\n);\n```\n\n### Activity Log Table\n```sql\nCREATE TABLE po_activity_log (\n  id VARCHAR(36) PRIMARY KEY,\n  po_id VARCHAR(20) NOT NULL,\n  user_id INTEGER NOT NULL,\n  user_name VARCHAR(255) NOT NULL,\n  action VARCHAR(100) NOT NULL,\n  activity_type VARCHAR(50) NOT NULL,\n  description TEXT,\n  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  FOREIGN KEY (po_id) REFERENCES purchase_orders(po_id)\n);\n```\n\n---\n\n*Generated on: $(date)*\n*Module Version: 1.0*\n*Last Updated: Latest*";

        // Initialize mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default'
        });

        // Configure marked
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Render markdown
        document.getElementById('markdown-content').innerHTML = marked.parse(markdownContent);

        // Render mermaid diagrams
        mermaid.contentLoaded();
    </script>
</body>
</html>